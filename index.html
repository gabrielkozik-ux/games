<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Zahrajte si klasick√© retro hry jako Snake, Pong, Tetris a dal≈°√≠ p≈ô√≠mo ve va≈°em prohl√≠≈æeƒçi. Ark√°da pln√° nostalgick√© z√°bavy.">
    <title>Retro Hern√≠ Ark√°da</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&family=Silkscreen&family=Bungee&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: overflow 0.3s ease;
            overflow-x: hidden; /* Zabra≈àuje horizont√°ln√≠mu scrollov√°n√≠ */
        }
        /* Fonty */
        .font-press-start { font-family: 'Press Start 2P', cursive; }
        .font-vt323 { font-family: 'VT323', monospace; }
        .font-silkscreen { font-family: 'Silkscreen', cursive; }
        .font-bungee { font-family: 'Bungee', cursive; }

        /* Hern√≠ okno - z√°kladn√≠ stav */
        .game-window {
            aspect-ratio: 4 / 3;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 4px solid #1f2937;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.1);
            position: relative;
            background: none;
            padding: 0;
            text-align: inherit;
            overflow: hidden; /* D≈Øle≈æit√© pro clean look */
        }
        .game-window:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3), 0 10px 10px -5px rgba(0,0,0,0.2);
        }
        
        /* Aktivn√≠ hern√≠ okno (Fullscreen overlay efekt) */
        .game-window.active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 50;
            border: none;
            border-radius: 0;
            aspect-ratio: auto;
            transform: none;
            background-color: #111827; /* Tmav√© pozad√≠ v re≈æimu cel√© obrazovky */
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: default;
        }

        /* Elementy uvnit≈ô okna */
        .game-window h2 { transition: opacity 0.3s ease; }
        .game-window canvas { 
            display: none; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
            max-height: 80vh; /* Aby se ve≈°lo ovl√°d√°n√≠ */
        }
        
        /* Stavy p≈ôi aktivn√≠ h≈ôe */
        .game-window.active h2 { display: none; }
        .game-window.active .leaderboard { display: none; }
        .game-window.active canvas { display: block; }
        .game-window.active .controls-hint { display: flex; }
        .game-window.active .close-btn { display: flex; }

        /* Leaderboard */
        .leaderboard { display: none; width: 100%; padding: 0 1rem; }
        .leaderboard h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
        .leaderboard-list li {
            font-size: 1rem; padding: 4px 8px;
            display: flex; justify-content: space-between;
            border-radius: 4px; margin-bottom: 2px;
            background-color: rgba(255,255,255,0.1);
            backdrop-filter: blur(2px);
        }
        .leaderboard-list li:nth-child(odd) { background-color: rgba(255,255,255,0.05); }

        /* Odpoƒçet */
        .countdown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 8rem; color: white; 
            text-shadow: 4px 4px 0 #000;
            z-index: 60; pointer-events: none; opacity: 0; transition: opacity 0.2s ease-in-out;
        }

        /* Barvy pozad√≠ her */
        #snake-window { background-color: #a3e635; }
        #pong-window { background-color: #60a5fa; }
        #breakout-window { background-color: #facc15; }
        #dino-window { background-color: #d1d5db; }
        #invaders-window { background-color: #4c1d95; }
        #tetris-window { background-color: #fca5a5; }

        /* Utility */
        .noselect {
            -webkit-touch-callout: none; -webkit-user-select: none;
            -khtml-user-select: none; -moz-user-select: none;
            -ms-user-select: none; user-select: none;
        }

        /* Dotykov√© ovl√°d√°n√≠ */
        #touch-controls {
            display: none; /* Defaultnƒõ skryt√© */
            position: fixed; bottom: 20px; left: 0; width: 100%;
            padding: 0 20px; box-sizing: border-box; z-index: 100;
            justify-content: space-between; align-items: flex-end;
            pointer-events: none; /* Aby neblokovalo klik√°n√≠ skrz pr√°zdn√° m√≠sta */
        }
        .game-window.active ~ #touch-controls {
            /* Zobraz√≠ se jen na mobilech p≈ôes media query n√≠≈æe, ale logika je p≈ôipraven√° */
        }

        #touch-controls button {
            pointer-events: auto;
            width: 60px; height: 60px; font-size: 24px;
            border: 3px solid #1f2937; background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%; color: #1f2937; font-family: 'Press Start 2P', cursive;
            backdrop-filter: blur(4px);
            active: scale(0.9);
            transition: transform 0.1s;
            box-shadow: 0 4px 0 #000;
        }
        #touch-controls button:active { transform: translateY(4px); box-shadow: 0 0 0 #000; }
        
        #d-pad { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); grid-gap: 10px; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }
        #btn-action { width: 80px; height: 80px; font-size: 30px; border-radius: 50%; background-color: #ef4444; color: white; border-color: #991b1b; }

        /* Mute tlaƒç√≠tko */
        #mute-button {
            position: fixed; top: 20px; right: 20px; z-index: 200;
            background: rgba(0,0,0,0.6); color: white;
            border: 2px solid white; border-radius: 50%;
            width: 44px; height: 44px; font-size: 20px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        #mute-button:hover { background: rgba(0,0,0,0.8); transform: scale(1.1); }

        /* Tlaƒç√≠tko ZAV≈ò√çT (NOV√â) */
        .close-btn {
            display: none; /* Viditeln√© jen v active re≈æimu */
            position: absolute;
            top: 20px;
            left: 20px;
            background: #ef4444;
            color: white;
            font-family: 'Bungee', cursive;
            font-size: 1.2rem;
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid white;
            cursor: pointer;
            z-index: 101;
            box-shadow: 0 4px 0 #991b1b;
            transition: all 0.1s;
            text-transform: uppercase;
            align-items: center;
            gap: 8px;
        }
        .close-btn:active { transform: translateY(4px); box-shadow: none; }

        /* N√°povƒõda ovl√°d√°n√≠ (NOV√â) */
        .controls-hint {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            gap: 10px;
            align-items: center;
            pointer-events: none;
            white-space: nowrap;
        }
        .key-icon {
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            font-family: sans-serif;
            font-size: 0.9rem;
        }

        /* Responsivita */
        @media (max-width: 768px) {
            #touch-controls { display: flex; }
            .controls-hint { display: none !important; /* Na mobilu schov√°me n√°povƒõdu kl√°vesnice */ }
            .game-window.active { justify-content: flex-start; padding-top: 60px; }
            .game-window.active canvas { max-height: 55vh; } /* V√≠ce m√≠sta pro tlaƒç√≠tka */
            .close-btn { top: 10px; left: 10px; padding: 6px 12px; font-size: 1rem; }
            #mute-button { top: 10px; right: 10px; }
            h1 { font-size: 2rem; }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-8 flex flex-col min-h-screen noselect">

    <button id="mute-button" title="Vypnout/Zapnout zvuk">üîä</button>

    <header class="text-center mb-6 sm:mb-10">
        <h1 class="text-4xl md:text-6xl font-bungee tracking-wider text-yellow-400 drop-shadow-md">Retro Hern√≠ Ark√°da</h1>
        <p class="text-gray-300 mt-2 font-vt323 text-2xl">Klikni na hru a hraj!</p>
        <p class="text-gray-400 mt-1 font-vt323 text-lg">Created by Gabriel</p>
        
        <div id="user-section" class="mt-6 min-h-[40px]">
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded shadow-lg transition font-sans">
                G P≈ôihl√°sit se p≈ôes Google
            </button>
            <div id="user-info" class="hidden flex flex-col items-center gap-2">
                <p class="font-vt323 text-xl">Hr√°ƒç: <span id="user-name" class="text-yellow-400"></span></p>
                <button id="logout-btn" class="text-sm text-red-400 hover:text-red-300 underline">Odhl√°sit se</button>
            </div>
        </div>
    </header>

    <main class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 max-w-7xl mx-auto w-full">
        
        <!-- ≈†ABLONA PRO HRY (Opakuje se struktura) -->
        
        <!-- SNAKE -->
        <div id="snake-window" class="game-window group" data-game="snake">
            <button class="close-btn">‚ùå Zpƒõt do menu</button>
            <h2 class="text-4xl md:text-5xl font-press-start text-gray-900 group-hover:scale-110 transition-transform">SNAKE</h2>
            <div class="leaderboard mt-4">
                <h3 class="text-xl font-vt323 text-gray-800 font-bold">üèÜ TOP 5 HR√Åƒå≈Æ</h3>
                <ol class="leaderboard-list text-gray-900 font-vt323"></ol>
            </div>
            <canvas id="snake-canvas"></canvas>
            <div class="countdown-overlay font-press-start"></div>
            <div class="controls-hint">
                <span class="key-icon">‚¨Ü‚¨á‚¨Ö‚û°</span> Pohyb <span class="key-icon" style="margin-left:10px">Mezern√≠k</span> Pauza
            </div>
        </div>

        <!-- PONG -->
        <div id="pong-window" class="game-window group" data-game="pong">
            <button class="close-btn">‚ùå Zpƒõt do menu</button>
            <h2 class="text-4xl md:text-5xl font-silkscreen text-gray-900 group-hover:scale-110 transition-transform">PONG</h2>
            <div class="leaderboard mt-4">
                <h3 class="text-xl font-vt323 text-gray-800 font-bold">üèÜ TOP 5 HR√Åƒå≈Æ</h3>
                <ol class="leaderboard-list text-gray-900 font-vt323"></ol>
            </div>
            <canvas id="pong-canvas"></canvas>
            <div class="countdown-overlay font-silkscreen"></div>
            <div class="controls-hint">
                <span class="key-icon">‚¨Ü‚¨á</span> Pohyb <span class="key-icon" style="margin-left:10px">Mezern√≠k</span> Pauza
            </div>
        </div>

        <!-- BREAKOUT -->
        <div id="breakout-window" class="game-window group" data-game="breakout">
            <button class="close-btn">‚ùå Zpƒõt do menu</button>
            <h2 class="text-4xl md:text-5xl font-bungee text-gray-900 group-hover:scale-110 transition-transform">BREAKOUT</h2>
            <div class="leaderboard mt-4">
                <h3 class="text-xl font-vt323 text-gray-800 font-bold">üèÜ TOP 5 HR√Åƒå≈Æ</h3>
                <ol class="leaderboard-list text-gray-900 font-vt323"></ol>
            </div>
            <canvas id="breakout-canvas"></canvas>
            <div class="countdown-overlay font-bungee"></div>
            <div class="controls-hint">
                <span class="key-icon">‚¨Ö‚û°</span> Pohyb <span class="key-icon" style="margin-left:10px">Mezern√≠k</span> Pauza
            </div>
        </div>

        <!-- DINO -->
        <div id="dino-window" class="game-window group" data-game="dino">
            <button class="close-btn">‚ùå Zpƒõt do menu</button>
            <h2 class="text-4xl md:text-5xl font-vt323 text-gray-900 group-hover:scale-110 transition-transform">DINO RUN</h2>
            <div class="leaderboard mt-4">
                <h3 class="text-xl font-vt323 text-gray-800 font-bold">üèÜ TOP 5 HR√Åƒå≈Æ</h3>
                <ol class="leaderboard-list text-gray-900 font-vt323"></ol>
            </div>
            <canvas id="dino-canvas"></canvas>
            <div class="countdown-overlay font-vt323"></div>
            <div class="controls-hint">
                <span class="key-icon">‚¨Ü / SPACE</span> Skok <span class="key-icon">‚¨á</span> Skrƒçit
            </div>
        </div>

        <!-- INVADERS -->
        <div id="invaders-window" class="game-window group" data-game="invaders">
            <button class="close-btn">‚ùå Zpƒõt do menu</button>
            <h2 class="text-3xl md:text-4xl font-press-start text-white text-center group-hover:scale-110 transition-transform leading-snug">SPACE<br>INVADERS</h2>
            <div class="leaderboard mt-4">
                <h3 class="text-xl font-vt323 text-white font-bold">üèÜ TOP 5 HR√Åƒå≈Æ</h3>
                <ol class="leaderboard-list text-white font-vt323"></ol>
            </div>
            <canvas id="invaders-canvas"></canvas>
            <div class="countdown-overlay font-press-start"></div>
            <div class="controls-hint">
                <span class="key-icon">‚¨Ö‚û°</span> Pohyb <span class="key-icon">SPACE</span> St≈ôelba
            </div>
        </div>

        <!-- TETRIS -->
        <div id="tetris-window" class="game-window group" data-game="tetris">
            <button class="close-btn">‚ùå Zpƒõt do menu</button>
            <h2 class="text-4xl md:text-5xl font-silkscreen text-gray-900 group-hover:scale-110 transition-transform">TETRIS</h2>
            <div class="leaderboard mt-4">
                <h3 class="text-xl font-vt323 text-gray-800 font-bold">üèÜ TOP 5 HR√Åƒå≈Æ</h3>
                <ol class="leaderboard-list text-gray-900 font-vt323"></ol>
            </div>
            <canvas id="tetris-canvas"></canvas>
            <div class="countdown-overlay font-silkscreen"></div>
            <div class="controls-hint">
                <span class="key-icon">‚¨Ö‚û°</span> Pohyb <span class="key-icon">‚¨Ü</span> Rotace <span class="key-icon">‚¨á</span> Rychle dol≈Ø
            </div>
        </div>
    </main>

    <!-- Touch Controls (Mobiln√≠) -->
    <div id="touch-controls">
        <div id="d-pad">
            <button id="btn-left">‚óÑ</button>
            <button id="btn-up">‚ñ≤</button>
            <button id="btn-down">‚ñº</button>
            <button id="btn-right">‚ñ∫</button>
        </div>
        <div id="action-button">
            <button id="btn-action">A</button>
        </div>
    </div>

    <footer class="mt-12 pb-8 border-t border-gray-800 text-center">
        <div class="flex flex-col md:flex-row items-center justify-center gap-8 mt-8">
            <div class="text-left">
                <h3 class="font-bungee text-2xl text-yellow-400 mb-2">L√≠b√≠ se ti hry?</h3>
                <p class="text-gray-400 font-vt323 text-xl">M≈Ø≈æe≈° mi podƒõkovat koup√≠ lahodn√© k√°vy.</p>
                <a href="https://buymeacoffee.com/gaboslovak" target="_blank" class="mt-4 inline-block bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-yellow-300 transition-colors font-sans shadow-lg transform hover:-translate-y-1">
                    ‚òï buymeacoffee.com/gaboslovak
                </a>
            </div>
            <div>
                <img src="bmc_qr.png" alt="QR k√≥d pro Buy Me a Coffee" class="w-32 h-32 rounded-lg border-4 border-gray-700 shadow-xl" width="128" height="128">
            </div>
        </div>
    </footer>
    
    <!-- AUDIO ASSETS -->
    <audio id="snake-music" loop><source src="hadi-tanec.mp3" type="audio/mpeg"></audio>
    <audio id="pong-music" loop><source src="pong.mp3" type="audio/mpeg"></audio>
    <audio id="breakout-music" loop><source src="breakout.mp3" type="audio/mpeg"></audio>
    <audio id="dino-music" loop><source src="Dino-run.mp3" type="audio/mpeg"></audio>
    <audio id="invaders-music" loop><source src="space-invaders.mp3" type="audio/mpeg"></audio>
    <audio id="tetris-music" loop><source src="tetris.mp3" type="audio/mpeg"></audio>
    <audio id="game-over-sound"><source src="game-over.mp3" type="audio/mpeg"></audio>
    <audio id="ready-fight-sound"><source src="ready-fight.mp3" type="audio/mpeg"></audio>
    <audio id="victory-sound"><source src="victory.mp3" type="audio/mpeg"></audio>

    <script>
        // --- INICIALIZACE FIREBASE ---
        // Ponech√°na p≈Øvodn√≠ konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyBWJAbTCutFX3sU_KLt6XSCvhJ_Vl5trjo",
            authDomain: "retro-herni-arkada.firebaseapp.com",
            projectId: "retro-herni-arkada",
            storageBucket: "retro-herni-arkada.appspot.com",
            messagingSenderId: "15367501595",
            appId: "1:15367501595:web:f8323a29e3c24a6dd985be"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOB√ÅLN√ç PROMƒöNN√â ---
        let activeGame = null;
        const gameInstances = {};
        const keysPressed = {};
        let isMuted = false;
        
        // --- FUNKCE PRO FIREBASE (Leaderboard & Score) ---
        async function displayLeaderboard(gameName) {
            const gameWindow = document.querySelector(`.game-window[data-game="${gameName}"]`);
            const listElement = gameWindow.querySelector('.leaderboard-list');
            if (!listElement) return;

            const currentUser = auth.currentUser;
            listElement.innerHTML = '<li>Naƒç√≠t√°n√≠...</li>';

            try {
                const querySnapshot = await db.collection("scores")
                    .where("game", "==", gameName)
                    .orderBy("score", "desc")
                    .limit(5)
                    .get();

                if (querySnapshot.empty) {
                    listElement.innerHTML = '<li style="justify-content:center; color:#888;">Zat√≠m ≈æ√°dn√© sk√≥re.</li>';
                    return;
                }

                listElement.innerHTML = '';
                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');

                    let deleteButtonHTML = '';
                    if (currentUser && data.userId === currentUser.uid) {
                        deleteButtonHTML = `<button data-id="${doc.id}" class="delete-score-btn text-red-500 font-bold ml-2 hover:text-red-700" title="Smazat">√ó</button>`;
                    }

                    let rankIcon = `${rank}.`;
                    if (rank === 1) {
                        rankIcon = 'ü•á';
                        listItem.style.fontWeight = 'bold';
                        listItem.style.color = '#fbbf24'; // Gold
                    } else if (rank === 2) rankIcon = 'ü•à';
                    else if (rank === 3) rankIcon = 'ü•â';

                    listItem.innerHTML = `<span class="truncate mr-2">${rankIcon} ${escapeHtml(data.userName)}</span> <span class="whitespace-nowrap">${data.score}${deleteButtonHTML}</span>`;
                    listElement.appendChild(listItem);
                    rank++;
                });
            } catch (error) {
                console.error(`Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku pro ${gameName}:`, error);
                listElement.innerHTML = '<li>Chyba naƒç√≠t√°n√≠ dat.</li>';
            }
        }
        
        // Jednoduch√° ochrana proti XSS p≈ôi v√Ωpisu jm√©na
        function escapeHtml(text) {
            if (!text) return 'Anonym';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function saveCurrentScore() {
            const user = auth.currentUser;
            if (user && activeGame) {
                const gameName = activeGame;
                let scoreToSave = 0;

                if (gameName === 'pong') {
                    scoreToSave = gameInstances[gameName].player.score;
                } else {
                    scoreToSave = gameInstances[gameName].score;
                }

                if (gameName === 'dino' && scoreToSave > 0) {
                    scoreToSave = Math.floor(scoreToSave / 5);
                }

                if (scoreToSave > 0) {
                    db.collection("scores").add({
                        userId: user.uid,
                        userName: user.displayName,
                        game: gameName,
                        score: scoreToSave,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        console.log("Sk√≥re ulo≈æeno.");
                        displayLeaderboard(gameName);
                    })
                    .catch((error) => console.error("Chyba ukl√°d√°n√≠:", error));
                }
            }
        }

        // --- HERN√ç LOGIKA A OVL√ÅD√ÅN√ç ZVUKU ---

        const allAudio = document.querySelectorAll('audio');
        const muteButton = document.getElementById('mute-button');
        const gameOverSound = document.getElementById('game-over-sound');
        const readyFightSound = document.getElementById('ready-fight-sound');
        const victorySound = document.getElementById('victory-sound');

        // Bezpeƒçn√© p≈ôehr√°v√°n√≠ zvuku (prevence error≈Ø v prohl√≠≈æeƒçi)
        function safePlay(audioElement) {
            if (!audioElement) return;
            const playPromise = audioElement.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay blocked or error:", error);
                });
            }
        }

        muteButton.addEventListener('click', () => {
            isMuted = !isMuted;
            allAudio.forEach(audio => audio.muted = isMuted);
            muteButton.textContent = isMuted ? 'üîá' : 'üîä';
            localStorage.setItem('isMuted', isMuted);
        });

        window.addEventListener('keydown', (e) => { 
            // Prevence scrollov√°n√≠ mezern√≠kem a ≈°ipkami, pokud bƒõ≈æ√≠ hra
            if (activeGame && [' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
            keysPressed[e.key] = true; 
        });
        window.addEventListener('keyup', (e) => { keysPressed[e.key] = false; });
        
        function stopAllMusic() {
            if (activeGame && gameInstances[activeGame].music) {
                gameInstances[activeGame].music.pause();
                gameInstances[activeGame].music.currentTime = 0;
            }
        }

        function playGameOverSound() {
            stopAllMusic();
            gameOverSound.currentTime = 0;
            safePlay(gameOverSound);
            document.body.style.overflow = 'auto'; // Povol√≠me scroll
            saveCurrentScore();
        }

        function playVictorySound() {
            stopAllMusic();
            victorySound.currentTime = 0;
            safePlay(victorySound);
            document.body.style.overflow = 'auto';
            saveCurrentScore();
        }
        
        function playCountdown(game, callback) {
            const overlay = game.canvas.nextElementSibling;
            let count = 3;
            readyFightSound.currentTime = 0;
            safePlay(readyFightSound);
            
            // Zobraz√≠me overlay
            overlay.style.opacity = 1;
            overlay.innerText = count;
            
            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    overlay.innerText = count;
                } else if (count === 0) {
                    overlay.innerText = "GO!";
                } else {
                    clearInterval(interval);
                    overlay.style.opacity = 0;
                    callback();
                }
            }, 600); // Zrychlen√Ω odpoƒçet
        }

        // --- DEFINICE HER ---

        // --- SNAKE (VYLEP≈†EN√ù) ---
        gameInstances.snake = {
            canvas: document.getElementById('snake-canvas'), music: document.getElementById('snake-music'), ctx: null, 
            tileSize: 20, snake: [], food: {}, 
            direction: 'right', newDirection: 'right', lastProcessedDirection: 'right', // FIX: P≈ôid√°na lastProcessedDirection
            score: 0, gameOver: false, paused: false, loop: null, lastUpdateTime: 0, updateInterval: 120,
            
            init() { this.ctx = this.canvas.getContext('2d'); this.reset(); window.addEventListener('keydown', this.handleInput.bind(this)); },
            reset() { 
                this.snake = [{ x: 10, y: 10 }, {x:9, y:10}, {x:8, y:10}]; // Had m√° na zaƒç√°tku d√©lku 3
                this.direction = 'right'; this.newDirection = 'right'; this.lastProcessedDirection = 'right';
                this.score = 0; this.gameOver = false; 
                if(this.canvas.width > 0) this.placeFood(); 
                this.music.currentTime = 0; 
            },
            placeFood() { 
                const c = Math.floor(this.canvas.width / this.tileSize), r = Math.floor(this.canvas.height / this.tileSize); 
                this.food = { x: Math.floor(Math.random() * c), y: Math.floor(Math.random() * r) }; 
                // Kontrola, aby j√≠dlo nebylo v hadovi
                for(let part of this.snake) {
                    if(part.x === this.food.x && part.y === this.food.y) this.placeFood();
                }
            },
            handleInput(e) { 
                if (activeGame !== 'snake' || this.paused) return; 
                // FIX: Kontrola proti lastProcessedDirection m√≠sto current direction
                if (e.key === 'ArrowUp' && this.lastProcessedDirection !== 'down') this.newDirection = 'up'; 
                else if (e.key === 'ArrowDown' && this.lastProcessedDirection !== 'up') this.newDirection = 'down'; 
                else if (e.key === 'ArrowLeft' && this.lastProcessedDirection !== 'right') this.newDirection = 'left'; 
                else if (e.key === 'ArrowRight' && this.lastProcessedDirection !== 'left') this.newDirection = 'right'; 
            },
            update() { 
                if (this.gameOver) return; 
                this.direction = this.newDirection; 
                
                const head = { ...this.snake[0] }; 
                if (this.direction === 'right') head.x++; 
                if (this.direction === 'left') head.x--; 
                if (this.direction === 'up') head.y--; 
                if (this.direction === 'down') head.y++; 
                
                // Ulo≈æ√≠me smƒõr, kter√Ω byl pr√°vƒõ vykon√°n (pro validaci vstupu)
                this.lastProcessedDirection = this.direction;

                const c = Math.floor(this.canvas.width / this.tileSize), r = Math.floor(this.canvas.height / this.tileSize); 
                
                // Kolize se zd√≠
                if (head.x < 0 || head.x >= c || head.y < 0 || head.y >= r) { this.gameOver = true; playGameOverSound(); return; } 
                // Kolize s tƒõlem
                for (let i = 0; i < this.snake.length; i++) { if (head.x === this.snake[i].x && head.y === this.snake[i].y) { this.gameOver = true; playGameOverSound(); return; } } 
                
                this.snake.unshift(head); 
                if (head.x === this.food.x && head.y === this.food.y) { this.score++; this.placeFood(); } 
                else { this.snake.pop(); } 
            },
            draw() { 
                this.ctx.fillStyle = '#1a2e05'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); 
                // Kreslen√≠ hada
                this.snake.forEach((seg, index) => { 
                    this.ctx.fillStyle = index === 0 ? '#bef264' : '#84cc16'; // Hlava svƒõtlej≈°√≠
                    this.ctx.fillRect(seg.x * this.tileSize, seg.y * this.tileSize, this.tileSize - 1, this.tileSize - 1); 
                }); 
                // Kreslen√≠ j√≠dla
                this.ctx.fillStyle = '#ef4444'; 
                this.ctx.beginPath();
                this.ctx.arc(this.food.x * this.tileSize + this.tileSize/2, this.food.y * this.tileSize + this.tileSize/2, this.tileSize/2 - 2, 0, Math.PI*2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'white'; this.ctx.font = `16px "Press Start 2P"`; 
                this.ctx.fillText(`Score: ${this.score}`, 10, 30); 
                
                if (this.gameOver) this.drawGameOver();
            },
            drawGameOver() {
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); 
                this.ctx.fillStyle = 'white'; this.ctx.textAlign = 'center'; 
                this.ctx.font = '30px "Press Start 2P"'; this.ctx.fillText('GAME OVER', this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.font = '12px "Press Start 2P"'; this.ctx.fillText('Press Close to Menu', this.canvas.width / 2, this.canvas.height / 2 + 40);
                this.ctx.textAlign = 'start'; // Reset
            },
            gameLoop(time) { if (!this.paused) { if (time - this.lastUpdateTime > this.updateInterval) { this.update(); this.lastUpdateTime = time; } this.draw(); } this.loop = requestAnimationFrame(this.gameLoop.bind(this)); },
            start() { this.paused = false; this.lastUpdateTime = 0; if(this.loop) cancelAnimationFrame(this.loop); this.loop = requestAnimationFrame(this.gameLoop.bind(this)); safePlay(this.music); },
            stop() { if(this.loop) cancelAnimationFrame(this.loop); this.loop = null; this.paused = true; this.music.pause(); document.body.style.overflow = 'auto'; },
            togglePause() { this.paused = !this.paused; if (this.gameOver) { /* Nic */ } else if (this.paused) this.music.pause(); else this.music.play(); }
        };

        // --- PONG ---
        gameInstances.pong = {
            canvas: document.getElementById('pong-canvas'), music: document.getElementById('pong-music'), ctx: null, 
            ball: {}, player: {}, ai: {}, paddleWidth: 0, paddleHeight: 0, 
            paused: false, loop: null, maxScore: 15, gameOver: false, gameWon: false,
            init() { this.ctx = this.canvas.getContext('2d'); },
            reset() { 
                this.paddleWidth = this.canvas.width / 70; this.paddleHeight = this.canvas.height / 5; 
                this.ball = { x: this.canvas.width / 2, y: this.canvas.height / 2, size: this.canvas.width / 80, dx: 5, dy: 5 }; 
                this.player = { x: 10, y: this.canvas.height / 2 - this.paddleHeight / 2, width: this.paddleWidth, height: this.paddleHeight, score: 0, speed: 8 }; 
                this.ai = { x: this.canvas.width - 10 - this.paddleWidth, y: this.canvas.height / 2 - this.paddleHeight / 2, width: this.paddleWidth, height: this.paddleHeight, score: 0, speed: 5 }; 
                this.gameOver = false; this.gameWon = false; this.music.currentTime = 0; 
            },
            update() {
                if (this.paused || this.gameOver || this.gameWon) return;
                if (this.ai.score >= this.maxScore) { this.gameOver = true; playGameOverSound(); return; }
                if (this.player.score >= this.maxScore) { this.gameWon = true; playVictorySound(); return; }

                // Player Move
                if (keysPressed['ArrowUp']) this.player.y -= this.player.speed;
                if (keysPressed['ArrowDown']) this.player.y += this.player.speed;
                this.player.y = Math.max(0, Math.min(this.canvas.height - this.player.height, this.player.y));

                // Ball Move
                this.ball.x += this.ball.dx; this.ball.y += this.ball.dy;

                // Wall collision (Top/Bottom)
                if (this.ball.y + this.ball.size > this.canvas.height || this.ball.y - this.ball.size < 0) this.ball.dy *= -1;

                // Paddle collision logic
                let paddle = (this.ball.x < this.canvas.width / 2) ? this.player : this.ai;
                if (this.ball.x - this.ball.size < paddle.x + paddle.width && 
                    this.ball.x + this.ball.size > paddle.x && 
                    this.ball.y > paddle.y && 
                    this.ball.y < paddle.y + paddle.height) {
                        // Simple bounce + speed up
                        this.ball.dx *= -1.05;
                        // Prevent stuck in paddle
                        if(paddle === this.player) this.ball.x = this.player.x + this.player.width + this.ball.size;
                        else this.ball.x = this.ai.x - this.ball.size;
                }

                // Scoring
                if (this.ball.x + this.ball.size < 0) { this.ai.score++; this.resetBall(); }
                if (this.ball.x - this.ball.size > this.canvas.width) { this.player.score++; this.resetBall(); }

                // AI Logic
                const aiCenter = this.ai.y + this.ai.height / 2;
                if (aiCenter < this.ball.y - 35) this.ai.y += this.ai.speed;
                else if (aiCenter > this.ball.y + 35) this.ai.y -= this.ai.speed;
                this.ai.y = Math.max(0, Math.min(this.canvas.height - this.ai.height, this.ai.y));
            },
            resetBall() { this.ball.x = this.canvas.width / 2; this.ball.y = this.canvas.height / 2; this.ball.dx = (Math.random() > 0.5 ? 1 : -1) * 5; this.ball.dy = (Math.random() > 0.5 ? 1 : -1) * 5; },
            draw() {
                this.ctx.fillStyle = '#0f172a'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.strokeStyle = 'rgba(255,255,255,0.1)'; this.ctx.setLineDash([10, 10]); this.ctx.beginPath(); this.ctx.moveTo(this.canvas.width / 2, 0); this.ctx.lineTo(this.canvas.width / 2, this.canvas.height); this.ctx.stroke(); this.ctx.setLineDash([]);
                this.ctx.fillStyle = 'white'; 
                this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height); 
                this.ctx.fillRect(this.ai.x, this.ai.y, this.ai.width, this.ai.height);
                this.ctx.beginPath(); this.ctx.arc(this.ball.x, this.ball.y, this.ball.size, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.font = `40px "Silkscreen"`; this.ctx.textAlign = 'center'; 
                this.ctx.fillText(this.player.score, this.canvas.width / 4, 60); 
                this.ctx.fillText(this.ai.score, this.canvas.width * 3 / 4, 60);
                if (this.gameOver || this.gameWon) {
                    this.ctx.fillStyle = 'rgba(0,0,0,0.8)'; this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height);
                    this.ctx.fillStyle = this.gameWon ? '#fde047' : 'white';
                    this.ctx.fillText(this.gameWon ? 'YOU WIN!' : 'GAME OVER', this.canvas.width/2, this.canvas.height/2);
                }
            },
            gameLoop() { if (!this.paused) { this.update(); this.draw(); } this.loop = requestAnimationFrame(this.gameLoop.bind(this)); },
            start() { this.paused = false; if(this.loop) cancelAnimationFrame(this.loop); this.loop = requestAnimationFrame(this.gameLoop.bind(this)); safePlay(this.music);},
            stop() { if(this.loop) cancelAnimationFrame(this.loop); this.loop = null; this.paused = true; this.music.pause(); document.body.style.overflow = 'auto';},
            togglePause() { this.paused = !this.paused; if (!this.gameOver && !this.gameWon && !this.paused) this.music.play(); else this.music.pause(); }
        };

        // --- BREAKOUT ---
        gameInstances.breakout = {
            canvas: document.getElementById('breakout-canvas'), music: document.getElementById('breakout-music'), ctx: null, paddle: {}, balls: [], bricks: [], powerUps: [], score: 0, lives: 3, paused: false, gameOver: false, loop: null,
            init() { this.ctx = this.canvas.getContext('2d'); },
            reset() { this.paddle = { x: this.canvas.width / 2 - 50, y: this.canvas.height - 20, width: 100, height: 10, speed: 10 }; this.balls = [{ x: this.canvas.width / 2, y: this.canvas.height - 30, size: 7, dx: 4, dy: -4 }]; this.powerUps = []; this.createBricks(); this.score = 0; this.lives = 3; this.gameOver = false; this.music.currentTime = 0; },
            createBricks() { this.bricks = []; const rows = 5, cols = 8, padding = 5; const brickWidth = (this.canvas.width - padding * (cols + 1)) / cols; const brickHeight = 20; for (let c = 0; c < cols; c++) for (let r = 0; r < rows; r++) this.bricks.push({ x: c * (brickWidth + padding) + padding, y: r * (brickHeight + padding) + padding + 40, width: brickWidth, height: brickHeight, visible: true }); },
            spawnPowerUp(x, y) { if (Math.random() < 0.2) { const type = Math.random() < 0.5 ? 'widePaddle' : 'multiBall'; this.powerUps.push({ x, y, size: 10, dy: 2, type }); } },
            update() {
                if (this.paused || this.gameOver) return;
                if (keysPressed['ArrowLeft']) this.paddle.x -= this.paddle.speed; if (keysPressed['ArrowRight']) this.paddle.x += this.paddle.speed;
                this.paddle.x = Math.max(0, Math.min(this.canvas.width - this.paddle.width, this.paddle.x));
                
                for (let i = this.balls.length - 1; i >= 0; i--) {
                    let ball = this.balls[i];
                    ball.x += ball.dx; ball.y += ball.dy;
                    if (ball.x + ball.size > this.canvas.width || ball.x - ball.size < 0) ball.dx *= -1;
                    if (ball.y - ball.size < 0) ball.dy *= -1;
                    
                    // Death
                    if (ball.y + ball.size > this.canvas.height) { 
                        this.balls.splice(i, 1); 
                        if (this.balls.length === 0) { 
                            this.lives--; 
                            if (this.lives <= 0) { this.gameOver = true; playGameOverSound(); } 
                            else { this.paddle.width = 100; this.balls.push({ x: this.canvas.width / 2, y: this.canvas.height - 30, size: 7, dx: 4, dy: -4 }); } 
                        } 
                    }
                    // Paddle Collision
                    if (ball.y + ball.size >= this.paddle.y && ball.y < this.paddle.y + this.paddle.height && ball.x > this.paddle.x && ball.x < this.paddle.x + this.paddle.width) {
                        ball.dy = -Math.abs(ball.dy) * 1.02; // Always bounce up
                        let hitPoint = ball.x - (this.paddle.x + this.paddle.width / 2);
                        ball.dx = hitPoint * 0.15; // English effect
                    }
                    // Brick Collision
                    this.bricks.forEach(brick => { 
                        if (brick.visible && ball.x > brick.x && ball.x < brick.x + brick.width && ball.y > brick.y && ball.y < brick.y + brick.height) { 
                            brick.visible = false; ball.dy *= -1; this.score++; this.spawnPowerUp(brick.x + brick.width / 2, brick.y + brick.height / 2); 
                        } 
                    });
                }
                this.powerUps.forEach((p, i) => { p.y += p.dy; if (p.y > this.canvas.height) this.powerUps.splice(i, 1); if (p.x > this.paddle.x && p.x < this.paddle.x + this.paddle.width && p.y > this.paddle.y && p.y < this.paddle.y + this.paddle.height) { if (p.type === 'widePaddle') this.paddle.width = 150; if (p.type === 'multiBall') this.balls.push({ x: this.paddle.x + this.paddle.width / 2, y: this.paddle.y - 10, size: 7, dx: (Math.random() - 0.5) * 8, dy: -4 }); this.powerUps.splice(i, 1); } });
                if (this.bricks.every(b => !b.visible)) { this.createBricks(); this.balls.push({ x: this.canvas.width / 2, y: this.canvas.height / 2, size: 7, dx: 4, dy: -4 }); }
            },
            draw() {
                this.ctx.fillStyle = '#4a044e'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#fde047'; this.ctx.fillRect(this.paddle.x, this.paddle.y, this.paddle.width, this.paddle.height);
                this.balls.forEach(ball => { this.ctx.beginPath(); this.ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2); this.ctx.fill(); });
                this.bricks.forEach((brick, i) => { if (brick.visible) { this.ctx.fillStyle = `hsl(${i * 10}, 70%, 60%)`; this.ctx.fillRect(brick.x, brick.y, brick.width-1, brick.height-1); } });
                this.powerUps.forEach(p => { this.ctx.fillStyle = p.type === 'widePaddle' ? '#22c55e' : '#3b82f6'; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); this.ctx.fill(); this.ctx.fillStyle='white'; this.ctx.textAlign='center'; this.ctx.font='10px sans-serif'; this.ctx.fillText(p.type[0].toUpperCase(), p.x, p.y+3);});
                
                this.ctx.fillStyle = 'white'; this.ctx.font = '20px "Bungee"'; this.ctx.textAlign = 'left'; this.ctx.fillText(`Score: ${this.score}`, 10, 30);
                this.ctx.textAlign = 'right'; this.ctx.fillText(`Lives: ${this.lives}`, this.canvas.width - 10, 30);
                
                if (this.gameOver) { this.ctx.fillStyle = 'rgba(0,0,0,0.7)'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height); this.ctx.fillStyle='white'; this.ctx.textAlign='center'; this.ctx.fillText('GAME OVER', this.canvas.width/2, this.canvas.height/2); }
            },
            gameLoop() { if (!this.paused) { this.update(); this.draw(); } this.loop = requestAnimationFrame(this.gameLoop.bind(this)); },
            start() { this.paused = false; if(this.loop) cancelAnimationFrame(this.loop); this.loop = requestAnimationFrame(this.gameLoop.bind(this)); safePlay(this.music);},
            stop() { if(this.loop) cancelAnimationFrame(this.loop); this.loop = null; this.paused = true; this.music.pause(); document.body.style.overflow = 'auto';},
            togglePause() { this.paused = !this.paused; if(!this.gameOver && !this.paused) this.music.play(); else this.music.pause(); }
        };
        
        // --- DINO RUN (Zachov√°no) ---
        gameInstances.dino = {
            canvas: document.getElementById('dino-canvas'), music: document.getElementById('dino-music'), ctx: null, dino: {}, obstacles: [], gameSpeed: 5, gravity: 0.6, score: 0, frameCount: 0, paused: false, gameOver: false, loop: null,
            init() { this.ctx = this.canvas.getContext('2d'); this.reset(); window.addEventListener('keydown', this.handleInput.bind(this)); window.addEventListener('keyup', this.handleKeyUp.bind(this)); },
            reset() { this.dino = { x: 50, y: 0, width: 44, height: 47, dy: 0, jumpPower: 15, grounded: true, isDucking: false, runFrame: 0 }; this.obstacles = []; this.score = 0; this.gameSpeed = 5; this.gameOver = false; this.frameCount = 0; this.music.currentTime = 0; },
            handleInput(e) { if (activeGame !== 'dino' || this.paused) return; if ((e.key === ' ' || e.key === 'ArrowUp') && this.dino.grounded) { this.dino.dy = -this.dino.jumpPower; this.dino.grounded = false; } else if (e.key === 'ArrowDown') { this.dino.isDucking = true; } },
            handleKeyUp(e) { if (activeGame !== 'dino' || this.paused) return; if (e.key === 'ArrowDown') { this.dino.isDucking = false; } },
            update() { if (this.paused || this.gameOver) return; this.frameCount++; this.score++; this.dino.dy += this.gravity; this.dino.y += this.dino.dy; const groundY = this.canvas.height - 20; if (this.dino.y + this.dino.height > groundY) { this.dino.y = groundY - this.dino.height; this.dino.dy = 0; this.dino.grounded = true; } if (this.dino.isDucking) { this.dino.height = 25; } else { this.dino.height = 47; } if (this.frameCount % 5 === 0) { this.dino.runFrame = (this.dino.runFrame + 1) % 2; } if (this.frameCount % Math.max(30, (100 - this.gameSpeed * 5)) === 0 && Math.random() < 0.5) { const type = Math.random() > 0.3 ? 'cactus' : 'bird'; if (type === 'cactus') { this.obstacles.push({ x: this.canvas.width, y: groundY - 50, width: 25, height: 50, type }); } else { this.obstacles.push({ x: this.canvas.width, y: groundY - (Math.random() > 0.5 ? 60 : 100), width: 45, height: 30, type, frame: 0 }); } } this.obstacles.forEach((obs, i) => { obs.x -= this.gameSpeed; if (obs.type === 'bird' && this.frameCount % 10 === 0) obs.frame = (obs.frame + 1) % 2; if (obs.x + obs.width < 0) this.obstacles.splice(i, 1); if (this.dino.x < obs.x + obs.width && this.dino.x + this.dino.width > obs.x && this.dino.y < obs.y + obs.height && this.dino.y + this.dino.height > obs.y) { this.gameOver = true; playGameOverSound(); } }); if (this.frameCount % 200 === 0) this.gameSpeed += 0.2; },
            drawDino() { const c = this.ctx; const d = this.dino; c.fillStyle = '#4b5563'; if (!this.dino.grounded) { c.fillRect(d.x, d.y, d.width, d.height); } else if (this.dino.isDucking) { c.fillRect(d.x, d.y, 58, d.height); } else { c.fillRect(d.x, d.y, d.width, d.height); } },
            drawCactus(obs) { this.ctx.fillStyle = '#166534'; this.ctx.fillRect(obs.x, obs.y, obs.width, obs.height); },
            drawBird(obs) { this.ctx.fillStyle = '#374151'; this.ctx.fillRect(obs.x, obs.y, obs.width, obs.height); },
            draw() { this.ctx.fillStyle = '#f3f4f6'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); this.ctx.fillStyle = '#4b5563'; this.ctx.fillRect(0, this.canvas.height - 20, this.canvas.width, 20); this.drawDino(); this.obstacles.forEach(obs => { if (obs.type === 'cactus') this.drawCactus(obs); else this.drawBird(obs); }); this.ctx.fillStyle = '#4b5563'; this.ctx.font = '24px "VT323"'; this.ctx.textAlign = 'right'; this.ctx.fillText(`SCORE: ${Math.floor(this.score/5)}`, this.canvas.width - 20, 30); if (this.gameOver) { this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); this.ctx.fillStyle = '#f3f4f6'; this.ctx.font = '32px "VT323"'; this.ctx.textAlign = 'center'; this.ctx.fillText('GAME OVER', this.canvas.width / 2, this.canvas.height / 2); } },
            gameLoop() { if (!this.paused) { this.update(); this.draw(); } this.loop = requestAnimationFrame(this.gameLoop.bind(this)); },
            start() { this.paused = false; if(this.loop) cancelAnimationFrame(this.loop); this.loop = requestAnimationFrame(this.gameLoop.bind(this)); safePlay(this.music); },
            stop() { if(this.loop) cancelAnimationFrame(this.loop); this.loop = null; this.paused = true; this.music.pause(); document.body.style.overflow = 'auto';},
            togglePause() { this.paused = !this.paused; if (!this.gameOver && !this.paused) this.music.play(); else this.music.pause(); }
        };

        // --- SPACE INVADERS ---
        gameInstances.invaders = {
            canvas: document.getElementById('invaders-canvas'), music: document.getElementById('invaders-music'), ctx: null, player: {}, bullets: [], invaders: [], invaderBullets: [], invaderDirection: 1, invaderSpeed: 0.5, score: 0, lives: 3, paused: false, gameOver: false, loop: null, lastShotTime: 0, shootCooldown: 300,
            init() { this.ctx = this.canvas.getContext('2d'); },
            reset() {
                this.player = { x: this.canvas.width / 2 - 25, y: this.canvas.height - 40, width: 50, height: 20, speed: 5 };
                this.bullets = []; this.invaderBullets = []; this.createInvaders(); this.score = 0; this.lives = 3; this.gameOver = false; this.music.currentTime = 0;
            },
            createInvaders() {
                this.invaders = []; const rows = 5; const cols = 10;
                const invaderWidth = this.canvas.width / 25; const invaderHeight = invaderWidth * 0.8;
                const invaderPadding = invaderWidth / 2; const totalRowWidth = cols * (invaderWidth + invaderPadding) - invaderPadding;
                const startX = (this.canvas.width - totalRowWidth) / 2; const startY = 30;
                for (let r = 0; r < rows; r++) { for (let c = 0; c < cols; c++) { this.invaders.push({ x: startX + c * (invaderWidth + invaderPadding), y: startY + r * (invaderHeight + invaderPadding), width: invaderWidth, height: invaderHeight }); } }
            },
            update() {
                if (this.paused || this.gameOver) return;
                if (keysPressed['ArrowLeft'] && this.player.x > 0) this.player.x -= this.player.speed;
                if (keysPressed['ArrowRight'] && this.player.x + this.player.width < this.canvas.width) this.player.x += this.player.speed;
                if (keysPressed[' '] && Date.now() - this.lastShotTime > this.shootCooldown) {
                    this.bullets.push({ x: this.player.x + this.player.width / 2 - 2.5, y: this.player.y, width: 5, height: 10, dy: -7 });
                    this.lastShotTime = Date.now();
                }
                // Update entities (zkr√°ceno pro p≈ôehlednost)
                this.bullets.forEach((b, i) => { b.y += b.dy; if (b.y < 0) this.bullets.splice(i, 1); });
                this.invaderBullets.forEach((b, i) => { b.y += b.dy; if(b.y > this.canvas.height) this.invaderBullets.splice(i,1); 
                    if(b.x > this.player.x && b.x < this.player.x+this.player.width && b.y > this.player.y && b.y < this.player.y+this.player.height) {
                        this.invaderBullets.splice(i,1); this.lives--; if(this.lives<=0){this.gameOver=true;playGameOverSound();}
                    }
                });
                let edgeReached = false;
                this.invaders.forEach(inv => { inv.x += this.invaderSpeed * this.invaderDirection; if (inv.x <= 0 || inv.x + inv.width >= this.canvas.width) edgeReached = true; if (inv.y + inv.height > this.player.y) { this.gameOver = true; playGameOverSound(); } });
                if (edgeReached) { this.invaderDirection *= -1; this.invaders.forEach(inv => inv.y += 20); }
                if (Math.random() < 0.02 && this.invaders.length > 0) { const s = this.invaders[Math.floor(Math.random()*this.invaders.length)]; this.invaderBullets.push({ x: s.x+s.width/2, y: s.y+s.height, width: 3, height: 7, dy: 4 }); }
                this.bullets.forEach((b,bi) => { this.invaders.forEach((inv,ii) => { if(b.x > inv.x && b.x < inv.x+inv.width && b.y > inv.y && b.y < inv.y+inv.height) { this.invaders.splice(ii,1); this.bullets.splice(bi,1); this.score+=10; } }); });
                if (this.invaders.length === 0) { this.createInvaders(); this.invaderSpeed += 0.2; }
            },
            draw() {
                this.ctx.fillStyle = '#000'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#0f0'; this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height);
                this.ctx.fillStyle = '#fff'; this.bullets.forEach(b => this.ctx.fillRect(b.x, b.y, b.width, b.height));
                this.ctx.fillStyle = '#f00'; this.invaderBullets.forEach(b => this.ctx.fillRect(b.x, b.y, b.width, b.height));
                this.ctx.fillStyle = '#ddd'; this.invaders.forEach(inv => this.ctx.fillRect(inv.x, inv.y, inv.width, inv.height));
                this.ctx.fillStyle = '#fff'; this.ctx.font = '20px "Press Start 2P"';
                this.ctx.textAlign = 'left'; this.ctx.fillText(`Score: ${this.score}`, 10, 25);
                this.ctx.textAlign = 'right'; this.ctx.fillText(`Lives: ${this.lives}`, this.canvas.width - 10, 25);
                if (this.gameOver) { this.ctx.fillStyle = 'rgba(255,0,0,0.6)'; this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height); this.ctx.fillStyle = 'white'; this.ctx.textAlign = 'center'; this.ctx.fillText('GAME OVER', this.canvas.width/2, this.canvas.height/2); }
            },
            gameLoop() { if (!this.paused) { this.update(); this.draw(); } this.loop = requestAnimationFrame(this.gameLoop.bind(this)); },
            start() { this.paused = false; if(this.loop) cancelAnimationFrame(this.loop); this.loop = requestAnimationFrame(this.gameLoop.bind(this)); safePlay(this.music); },
            stop() { if(this.loop) cancelAnimationFrame(this.loop); this.loop = null; this.paused = true; this.music.pause(); document.body.style.overflow = 'auto';},
            togglePause() { this.paused = !this.paused; if(!this.gameOver && !this.paused) this.music.play(); else this.music.pause(); }
        };
        
        // --- TETRIS (Zachov√°no) ---
        gameInstances.tetris = {
            canvas: document.getElementById('tetris-canvas'), music: document.getElementById('tetris-music'), ctx: null, grid: [], score: 0, gameOver: false, paused: false, loop: null, dropCounter: 0, dropInterval: 1000, lastTime: 0, cols: 12, rows: 20, blockSize: 0,
            player: { pos: { x: 0, y: 0 }, matrix: null, score: 0 }, nextPiece: null, pieces: 'TJLOSZI', colors: [null, '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#06b6d4', '#8b5cf6'],
            init() { this.ctx = this.canvas.getContext('2d'); window.addEventListener('keydown', this.handleInput.bind(this)); },
            reset() {
                if (this.canvas.height === 0) return;
                this.blockSize = this.canvas.height / this.rows;
                this.cols = Math.floor(this.canvas.width / this.blockSize);
                this.grid = this.createMatrix(this.cols, this.rows);
                this.score = 0; this.gameOver = false; this.paused = true;
                this.nextPiece = this.createPiece(this.pieces[Math.floor(Math.random() * this.pieces.length)]);
                this.playerReset();
                this.music.currentTime = 0;
            },
            createMatrix(w, h) { const matrix = []; while (h--) { matrix.push(new Array(w).fill(0)); } return matrix; },
            createPiece(type) { if (type === 'T') return [[0, 0, 0], [1, 1, 1], [0, 1, 0]]; else if (type === 'O') return [[2, 2], [2, 2]]; else if (type === 'L') return [[0, 3, 0], [0, 3, 0], [0, 3, 3]]; else if (type === 'J') return [[0, 4, 0], [0, 4, 0], [4, 4, 0]]; else if (type === 'I') return [[0, 5, 0, 0], [0, 5, 0, 0], [0, 5, 0, 0], [0, 5, 0, 0]]; else if (type === 'S') return [[0, 6, 6], [6, 6, 0], [0, 0, 0]]; else if (type === 'Z') return [[7, 7, 0], [0, 7, 7], [0, 0, 0]]; },
            playerReset() {
                this.player.matrix = this.nextPiece;
                this.nextPiece = this.createPiece(this.pieces[Math.floor(Math.random() * this.pieces.length)]);
                this.player.pos.y = 0; this.player.pos.x = (this.cols / 2 | 0) - (this.player.matrix[0].length / 2 | 0);
                if (this.collide(this.grid, this.player)) { this.gameOver = true; playGameOverSound(); }
            },
            collide(grid, player) { const [m, o] = [player.matrix, player.pos]; for (let y = 0; y < m.length; ++y) { for (let x = 0; x < m[y].length; ++x) { if (m[y][x] !== 0 && (grid[y + o.y] && grid[y + o.y][x + o.x]) !== 0) return true; } } return false; },
            merge(grid, player) { player.matrix.forEach((row, y) => { row.forEach((value, x) => { if (value !== 0) { grid[y + player.pos.y][x + player.pos.x] = value; } }); }); },
            rotate(matrix, dir) { for (let y = 0; y < matrix.length; ++y) { for (let x = 0; x < y; ++x) { [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]]; } } if (dir > 0) { matrix.forEach(row => row.reverse()); } else { matrix.reverse(); } },
            playerRotate(dir) { const pos = this.player.pos.x; let offset = 1; this.rotate(this.player.matrix, dir); while (this.collide(this.grid, this.player)) { this.player.pos.x += offset; offset = -(offset + (offset > 0 ? 1 : -1)); if (offset > this.player.matrix[0].length) { this.rotate(this.player.matrix, -dir); this.player.pos.x = pos; return; } } },
            gridSweep() { outer: for (let y = this.grid.length - 1; y > 0; --y) { for (let x = 0; x < this.grid[y].length; ++x) { if (this.grid[y][x] === 0) continue outer; } const row = this.grid.splice(y, 1)[0].fill(0); this.grid.unshift(row); ++y; this.score += 10; } },
            handleInput(e) { if (activeGame !== 'tetris' || this.paused || this.gameOver) return; if (e.key === 'ArrowLeft') this.playerMove(-1); else if (e.key === 'ArrowRight') this.playerMove(1); else if (e.key === 'ArrowDown') this.playerDrop(); else if (e.key === 'ArrowUp') this.playerRotate(1); },
            playerMove(dir) { this.player.pos.x += dir; if (this.collide(this.grid, this.player)) this.player.pos.x -= dir; },
            playerDrop() { this.player.pos.y++; if (this.collide(this.grid, this.player)) { this.player.pos.y--; this.merge(this.grid, this.player); this.playerReset(); this.gridSweep(); } this.dropCounter = 0; },
            update(time = 0) { if (this.gameOver) return; const deltaTime = time - this.lastTime; this.lastTime = time; this.dropCounter += deltaTime; if (this.dropCounter > this.dropInterval) { this.playerDrop(); } },
            drawMatrix(matrix, offset, size) {
                const blockSize = size || this.blockSize;
                matrix.forEach((row, y) => { row.forEach((value, x) => { if (value !== 0) { this.ctx.fillStyle = this.colors[value]; this.ctx.fillRect((x + offset.x) * blockSize, (y + offset.y) * blockSize, blockSize - 1, blockSize - 1); } }); });
            },
            draw() {
                this.ctx.fillStyle = '#1e293b'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                if (!this.grid || !this.player.matrix) return;
                this.drawMatrix(this.grid, { x: 0, y: 0 });
                this.drawMatrix(this.player.matrix, this.player.pos);
                this.ctx.fillStyle = 'white'; this.ctx.font = '16px "Silkscreen"'; this.ctx.textAlign = 'left'; this.ctx.fillText(`Score: ${this.score}`, 10, 20);
                if (this.gameOver) { this.ctx.fillStyle = 'rgba(255,255,255,0.8)'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height); this.ctx.fillStyle='black'; this.ctx.textAlign='center'; this.ctx.font='30px "Silkscreen"'; this.ctx.fillText('GAME OVER',this.canvas.width/2,this.canvas.height/2); }
            },
            gameLoop(time) { if (!this.paused) { this.update(time); this.draw(); } this.loop = requestAnimationFrame(this.gameLoop.bind(this)); },
            start() { this.paused = false; this.lastTime = 0; this.dropCounter = 0; if(this.loop) cancelAnimationFrame(this.loop); this.loop = requestAnimationFrame(this.gameLoop.bind(this)); safePlay(this.music); },
            stop() { if(this.loop) cancelAnimationFrame(this.loop); this.loop = null; this.paused = true; this.music.pause(); document.body.style.overflow = 'auto';},
            togglePause() { this.paused = !this.paused; if(!this.gameOver && !this.paused) this.music.play(); else this.music.pause(); }
        };

        // --- HLAVN√ç LOGIKA INTERAKCE ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedMuteState = localStorage.getItem('isMuted');
            if (savedMuteState === 'true') { isMuted = true; allAudio.forEach(audio => audio.muted = true); muteButton.textContent = 'üîá'; }
            
            Object.values(gameInstances).forEach(game => game.init());

            // Kliknut√≠ na hern√≠ okno
            document.querySelectorAll('.game-window').forEach(win => {
                win.addEventListener('click', (e) => {
                    // Ignorujeme kliknut√≠ na tlaƒç√≠tka uvnit≈ô
                    if (e.target.closest('.delete-score-btn') || e.target.closest('.close-btn')) return;

                    const gameName = win.dataset.game;
                    const game = gameInstances[gameName];

                    if (gameName === activeGame) {
                        game.togglePause();
                        return;
                    }
                    
                    // Zav≈ôeme p≈ôedchoz√≠ hru
                    if (activeGame && gameInstances[activeGame]) {
                        gameInstances[activeGame].stop();
                        document.querySelector(`[data-game="${activeGame}"]`).classList.remove('active');
                    }
                    
                    // Aktivujeme novou
                    document.body.style.overflow = 'hidden';
                    activeGame = gameName;
                    win.classList.add('active');
                    
                    // Restart pl√°tna
                    game.canvas.width = window.innerWidth;
                    game.canvas.height = window.innerHeight;
                    game.reset();
                    game.draw();
                    
                    playCountdown(game, () => game.start());
                });
                
                // Logika tlaƒç√≠tka ZPƒöT (CLOSE)
                const closeBtn = win.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Aby se hra nespustila znovu
                        const gameName = win.dataset.game;
                        if (gameInstances[gameName]) {
                            gameInstances[gameName].stop();
                            win.classList.remove('active');
                            activeGame = null;
                            document.body.style.overflow = 'auto';
                        }
                    });
                }
            });

            // Mobiln√≠ ovl√°d√°n√≠
            function simulateKeyEvent(type, key) { window.dispatchEvent(new KeyboardEvent(type, { 'key': key, 'bubbles': true })); }
            const touchControls = { 'btn-left': 'ArrowLeft', 'btn-right': 'ArrowRight', 'btn-up': 'ArrowUp', 'btn-down': 'ArrowDown', 'btn-action': ' ' };
            for (const [btnId, key] of Object.entries(touchControls)) {
                const button = document.getElementById(btnId);
                if (button) {
                    button.addEventListener('touchstart', (e) => { e.preventDefault(); simulateKeyEvent('keydown', key); button.style.transform='scale(0.9)'; }, { passive: false });
                    button.addEventListener('touchend', (e) => { e.preventDefault(); simulateKeyEvent('keyup', key); button.style.transform='scale(1)'; }, { passive: false });
                }
            }

            // Firebase Auth
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');
            const userNameEl = document.getElementById('user-name');

            loginBtn.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(e => console.error("Login error:", e));
            });
            logoutBtn.addEventListener('click', () => auth.signOut());

            auth.onAuthStateChanged(user => {
                const leaderboards = document.querySelectorAll('.leaderboard');
                if (user) {
                    loginBtn.classList.add('hidden');
                    userInfo.classList.remove('hidden');
                    userNameEl.textContent = user.displayName;
                    leaderboards.forEach(lb => lb.style.display = 'block');
                    Object.keys(gameInstances).forEach(displayLeaderboard);
                } else {
                    loginBtn.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                    leaderboards.forEach(lb => lb.style.display = 'none');
                }
            });

            Object.keys(gameInstances).forEach(displayLeaderboard);

            // Maz√°n√≠ sk√≥re
            document.querySelector('main').addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-score-btn')) {
                    e.stopPropagation();
                    const scoreId = e.target.dataset.id;
                    const gameName = e.target.closest('.game-window').dataset.game;
                    if (confirm("Opravdu chce≈° smazat tento z√°znam?")) {
                        try {
                            await db.collection('scores').doc(scoreId).delete();
                            displayLeaderboard(gameName);
                        } catch (error) { console.error("Error:", error); alert("Chyba maz√°n√≠."); }
                    }
                }
            });
            
            // Resize handler pro aktivn√≠ hru
            window.addEventListener('resize', () => {
                if (activeGame && gameInstances[activeGame]) {
                    const game = gameInstances[activeGame];
                    game.canvas.width = window.innerWidth;
                    game.canvas.height = window.innerHeight;
                    game.draw(); // P≈ôekreslit, aby nez≈Østalo ƒçern√©
                }
            });
        });
    </script>
    <script src="/_vercel/insights/script.js"></script>
</body>
</html>
