<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Retro herní arkáda v prohlížeči: Snake, Pong, Breakout, Tetris, Space Invaders a Dino Run. Podpora mobilního ovládání." />
  <title>Retro Herní Arkáda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Press+Start+2P&family=VT323&family=Silkscreen&family=Bungee&display=swap" rel="stylesheet">
  <style>
    :root{--indigo:#4f46e5;--bg:#0b1220}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif;background:#0b1220}
    .font-press-start{font-family:'Press Start 2P',cursive}
    .font-vt323{font-family:'VT323',monospace}
    .font-silkscreen{font-family:'Silkscreen',cursive}
    .font-bungee{font-family:'Bungee',cursive}

    .game-window{
      aspect-ratio: 4/3;
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      cursor: pointer;
      display:flex;justify-content:center;align-items:center;flex-direction:column;
      border:4px solid #1f2937;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.2), 0 4px 6px -2px rgba(0,0,0,.1);
      position:relative;text-align:inherit;background-color:#1f2937;color:#fff;overflow:hidden
    }
    .game-window:hover{transform:translateY(-2px);box-shadow:0 20px 25px -5px rgba(0,0,0,.2),0 8px 10px -6px rgba(0,0,0,.1);border-color:var(--indigo)}
    .game-window.active{
      position:fixed;inset:auto;top:50%;left:50%;width:min(92vw,960px);height:auto;max-height:92vh;
      transform:translate(-50%,-50%);z-index:50;cursor:default;border-color:var(--indigo)
    }
    .game-window.active canvas{height:auto}
    .game-window canvas{width:100%;height:100%;background:#000;display:block}

    /* always-visible title badge */
    .badge{
      position:absolute;left:10px;top:10px;padding:.25rem .5rem;border-radius:.5rem;font-weight:700;
      backdrop-filter:blur(6px);background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.15);z-index:2
    }

    /* Color themes for tiles */
    .tile-snake{background:linear-gradient(135deg,#14532d,#065f46)}
    .tile-pong{background:linear-gradient(135deg,#312e81,#1f2937)}
    .tile-breakout{background:linear-gradient(135deg,#14532d,#166534)}
    .tile-tetris{background:linear-gradient(135deg,#0c4a6e,#1e3a8a)}
    .tile-invaders{background:linear-gradient(135deg,#701a75,#3b0764)}
    .tile-dino{background:linear-gradient(135deg,#374151,#111827)}

    .game-overlay{
      position:absolute;inset:0;display:flex;justify-content:center;align-items:center;
      font-size:2rem;color:#fff;pointer-events:none;opacity:.15;z-index:1;text-shadow:0 2px 8px rgba(0,0,0,.35)
    }
    .game-window.active .game-overlay{opacity:0}

    #countdown{
      font-size:8rem;color:#fff;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      z-index:60;pointer-events:none;text-shadow:0 0 15px rgba(255,255,255,.7);display:none
    }

    /* UI bar */
    .game-ui{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:60;
      display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;
      background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.14);padding:.5rem .75rem;border-radius:.75rem
    }
    .ui-btn{font-weight:700;border:1px solid rgba(255,255,255,.2);padding:.4rem .7rem;border-radius:.5rem}
    .ui-btn:disabled{opacity:.5;cursor:not-allowed}

    /* Mobile controls */
    .mobile-controls{display:none;gap:.5rem;flex-wrap:wrap;justify-content:center}
    .mobile-controls.active{display:flex}
    .pad{display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:.35rem}
    .pad button,.act button{width:48px;height:48px;border-radius:.5rem;border:1px solid rgba(255,255,255,.2);font-weight:800}
    .act{display:flex;gap:.35rem}

    /* Help modal */
    .help-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:70}
    .help-modal.active{display:flex}
    .help-card{max-width:min(92vw,900px);max-height:85vh;overflow:auto;background:#0b1220;border:1px solid #334155;border-radius:12px;padding:16px}

    @media (max-width:640px){
      .game-window{aspect-ratio: 16/9}
      .badge{font-size:.8rem}
    }
  </style>
</head>
<body class="text-white selection:bg-indigo-500 selection:text-white">

  <div class="sm:hidden bg-yellow-500 text-black text-center p-2 font-bold">
    Mobilní verze: přidány dotykové ovladače. Pokud něco nefunguje, otočte telefon na šířku.
  </div>

  <div class="container mx-auto px-4 py-8">
    <header class="text-center mb-6">
      <h1 class="font-bungee text-5xl md:text-7xl font-bold mb-2 text-indigo-400 tracking-wider">Retro Herní Arkáda</h1>
      <p class="font-vt323 text-2xl text-gray-300">Klikněte na hru. Ovládání najdete v nápovědě (?).</p>
    </header>

    <!-- Quick help collapsible -->
    <section class="max-w-4xl mx-auto mb-10">
      <details class="bg-slate-800/60 rounded-xl border border-slate-700 p-4">
        <summary class="cursor-pointer font-semibold">Základní ovládání & tipy</summary>
        <ul class="mt-3 space-y-1 text-gray-300 text-sm leading-relaxed">
          <li>Spuštění / Pauza / Restart: ovládejte spodním panelem. Klávesy: <span class="font-mono">Space</span> pauza, <span class="font-mono">R</span> restart, <span class="font-mono">Esc</span> zavřít.</li>
          <li>Na mobilu použijte dotyková tlačítka. U Pong/Breakoutu pohybujte prstem po ploše hry.</li>
          <li>Kliknutí mimo aktivní okno hru zavře.</li>
        </ul>
      </details>
    </section>

    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Snake -->
      <button data-game="snake" class="game-window tile-snake" aria-label="Snake">
        <span class="badge">SNAKE</span>
        <div class="game-overlay font-press-start text-3xl">SNAKE</div>
        <canvas id="snake-canvas"></canvas>
      </button>
      <!-- Pong -->
      <button data-game="pong" class="game-window tile-pong" aria-label="Pong">
        <span class="badge">PONG</span>
        <div class="game-overlay font-press-start text-3xl">PONG</div>
        <canvas id="pong-canvas"></canvas>
      </button>
      <!-- Breakout -->
      <button data-game="breakout" class="game-window tile-breakout" aria-label="Breakout">
        <span class="badge">BREAKOUT</span>
        <div class="game-overlay font-press-start text-3xl">BREAKOUT</div>
        <canvas id="breakout-canvas"></canvas>
      </button>
      <!-- Tetris -->
      <button data-game="tetris" class="game-window tile-tetris" aria-label="Tetris">
        <span class="badge">TETRIS</span>
        <div class="game-overlay font-press-start text-3xl">TETRIS</div>
        <canvas id="tetris-canvas"></canvas>
        <canvas id="next-piece-canvas" class="hidden"></canvas>
      </button>
      <!-- Space Invaders -->
      <button data-game="invaders" class="game-window tile-invaders" aria-label="Space Invaders">
        <span class="badge">SPACE INVADERS</span>
        <div class="game-overlay font-press-start text-2xl">SPACE INVADERS</div>
        <canvas id="invaders-canvas"></canvas>
      </button>
      <!-- Dino Run -->
      <button data-game="dino" class="game-window tile-dino" aria-label="Dino Run">
        <span class="badge">DINO RUN</span>
        <div class="game-overlay font-press-start text-3xl">DINO RUN</div>
        <canvas id="dino-canvas"></canvas>
      </button>
    </main>

    <footer class="text-center mt-10 text-gray-500 font-vt323 text-lg">
      <p>&copy; 2025 Gabriel Kozik. Všechna práva vyhrazena.</p>
    </footer>
  </div>

  <!-- Countdown -->
  <div id="countdown" class="font-press-start" aria-live="polite"></div>

  <!-- Help Modal -->
  <div id="helpModal" class="help-modal">
    <div class="help-card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold">Nápověda & Ovládání</h2>
        <button id="helpClose" class="ui-btn bg-slate-700 hover:bg-slate-600">Zavřít</button>
      </div>
      <div class="space-y-4 text-gray-200 text-sm leading-relaxed">
        <div>
          <h3 class="font-semibold text-indigo-300">Univerzální</h3>
          <ul class="list-disc pl-5">
            <li>Start, Pauza, Restart ve spodní liště. Space = pauza, R = restart, Esc = zavřít.</li>
            <li>Na mobilu využijte tlačítka (šipky / akce). U Pong/Breakout pohybujte prstem po ploše.</li>
          </ul>
        </div>
        <div>
          <h3 class="font-semibold text-emerald-300">Snake</h3>
          <p>Šipky nebo dotykový kříž. Snězte jablko, nechte se nenarazit do sebe ani do stěny.</p>
        </div>
        <div>
          <h3 class="font-semibold text-violet-300">Pong</h3>
          <p>Myší/touch posouvejte pálku. První na 5 bodů vyhrává.</p>
        </div>
        <div>
          <h3 class="font-semibold text-green-300">Breakout</h3>
          <p>Myší/touch pálka. Sbírejte power‑upy: <em>widen</em> (šířka+), <em>shrink</em> (šířka−), <em>slow</em>, <em>speed</em>, <em>life</em> (+život).</p>
        </div>
        <div>
          <h3 class="font-semibold text-sky-300">Tetris</h3>
          <p>← → pohyb, ↓ drop, ↑ rotace. Plňte řádky.</p>
        </div>
        <div>
          <h3 class="font-semibold text-fuchsia-300">Space Invaders</h3>
          <p>← → pohyb, Space střelba. Zničte nepřátele dřív, než dosáhnou spodní hrany.</p>
        </div>
        <div>
          <h3 class="font-semibold text-zinc-300">Dino Run</h3>
          <p>Mezerník/↑ skok, ↓ podřep. Na mobilu tlačítka Skok / Duck.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- UI Bar -->
  <div id="uiBar" class="game-ui hidden">
    <button id="btnStart" class="ui-btn bg-emerald-600 hover:bg-emerald-500">Start</button>
    <button id="btnPause" class="ui-btn bg-amber-600 hover:bg-amber-500">Pauza</button>
    <button id="btnRestart" class="ui-btn bg-indigo-600 hover:bg-indigo-500">Restart</button>
    <button id="btnClose" class="ui-btn bg-rose-600 hover:bg-rose-500">Zavřít</button>
    <button id="btnHelp" class="ui-btn bg-slate-700 hover:bg-slate-600">?</button>
    <div id="mobileControls" class="mobile-controls w-full sm:w-auto">
      <!-- dynamic per game -->
    </div>
  </div>

  <!-- Audio (volitelné – soubory dle vašich názvů) -->
  <audio id="countdown-sound" src="ready-fight.mp3"></audio>
  <audio id="game-over-sound" src="game-over.mp3"></audio>
  <audio id="victory-sound" src="victory.mp3"></audio>
  <audio id="pong-music" loop src="pong.mp3"></audio>
  <audio id="breakout-music" loop src="breakout.mp3"></audio>
  <audio id="tetris-music" loop src="tetris.mp3"></audio>
  <audio id="dino-music" loop src="dino-run.mp3"></audio>
  <audio id="invaders-music" loop src="space-invaders.mp3"></audio>
  <audio id="snake-music" loop src="hadi-tanec.mp3"></audio>

<script>
let activeGame = null;
const gameInstances = {};

// --- Utility ---
function clamp(val,min,max){return Math.max(min,Math.min(max,val))}
function playSound(id){const el=document.getElementById(id); try{el.currentTime=0; el.play()}catch(e){}}
function stopSound(id){const el=document.getElementById(id); try{el.pause()}catch(e){}}

function playCountdown(cb){
  const el=document.getElementById('countdown');
  const s=document.getElementById('countdown-sound');
  let count=3; el.style.display='block'; el.textContent=count;
  try{s.currentTime=0; s.play()}catch(e){}
  const it=setInterval(()=>{
    count--;
    if(count>0){el.textContent=count}else{
      clearInterval(it); el.textContent='GO!';
      setTimeout(()=>{el.style.display='none'; cb&&cb()},420);
    }
  },1000);
}

function closeActiveWindow(){
  if(!activeGame) return;
  const prev = document.querySelector('[data-game="'+activeGame+'"]');
  if(prev){prev.classList.remove('active')}
  if(gameInstances[activeGame]){gameInstances[activeGame].stop()}
  activeGame=null;
  document.body.style.overflow='auto';
  // hide UI
  document.getElementById('uiBar').classList.add('hidden');
  document.getElementById('mobileControls').innerHTML='';
  document.getElementById('helpModal').classList.remove('active');
}

// Click outside to close
document.addEventListener('mousedown',(e)=>{
  const win = document.querySelector('.game-window.active');
  const ui = document.getElementById('uiBar');
  const help = document.getElementById('helpModal');
  if(!activeGame) return;
  const insideWin = win && win.contains(e.target);
  const insideUi = ui.contains(e.target);
  const insideHelp = help.contains(e.target);
  if(!insideWin && !insideUi && !insideHelp) closeActiveWindow();
});

// Keyboard shortcuts
document.addEventListener('keydown',(e)=>{
  if(!activeGame) return;
  if(e.code==='Escape'){ closeActiveWindow() }
  else if(e.code==='Space'){ e.preventDefault(); gameInstances[activeGame].togglePause() }
  else if(e.code==='KeyR'){ e.preventDefault(); gameInstances[activeGame].reset(); playCountdown(()=>gameInstances[activeGame].start()) }
});

function showHelp(){document.getElementById('helpModal').classList.add('active')}
function hideHelp(){document.getElementById('helpModal').classList.remove('active')}

// --- Unified UI bar ---
const ui = {
  bar: null, start:null, pause:null, restart:null, close:null, help:null, mobile:null,
  mount(){
    this.bar=document.getElementById('uiBar');
    this.start=document.getElementById('btnStart');
    this.pause=document.getElementById('btnPause');
    this.restart=document.getElementById('btnRestart');
    this.close=document.getElementById('btnClose');
    this.help=document.getElementById('btnHelp');
    this.mobile=document.getElementById('mobileControls');

    this.start.onclick=()=>{ if(activeGame){ playCountdown(()=>gameInstances[activeGame].start()) } };
    this.pause.onclick=()=>{ if(activeGame){ gameInstances[activeGame].togglePause() } };
    this.restart.onclick=()=>{ if(activeGame){ gameInstances[activeGame].reset(); playCountdown(()=>gameInstances[activeGame].start()) } };
    this.close.onclick=()=>closeActiveWindow();
    this.help.onclick=()=>showHelp();
    document.getElementById('helpClose').onclick=()=>hideHelp();
  },
  show(game){
    this.bar.classList.remove('hidden');
    this.mobile.innerHTML='';
    // dynamic mobile controls per game
    if(game==='snake'){
      this.mobile.classList.add('active');
      this.mobile.innerHTML=`
        <div class="pad" aria-label="D-pad">
          <span></span><button data-dir="up">↑</button><span></span>
          <button data-dir="left">←</button><button data-dir="noop">·</button><button data-dir="right">→</button>
          <span></span><button data-dir="down">↓</button><span></span>
        </div>`;
      this.mobile.querySelectorAll('button[data-dir]').forEach(b=>b.addEventListener('touchstart',(e)=>{
        const d=b.dataset.dir; if(d!=='noop') gameInstances.snake.setDirection(d);
      },{passive:true}));
    }else if(game==='invaders'){
      this.mobile.classList.add('active');
      this.mobile.innerHTML=`
        <div class="act">
          <button data-act="left">←</button>
          <button data-act="fire">●</button>
          <button data-act="right">→</button>
        </div>`;
      this.mobile.querySelector('[data-act="left"]').addEventListener('touchstart',()=>gameInstances.invaders.touchMove(-1),{passive:true});
      this.mobile.querySelector('[data-act="right"]').addEventListener('touchstart',()=>gameInstances.invaders.touchMove(1),{passive:true});
      this.mobile.querySelector('[data-act="fire"]').addEventListener('touchstart',()=>gameInstances.invaders.shoot(),{passive:true});
    }else if(game==='dino'){
      this.mobile.classList.add('active');
      this.mobile.innerHTML=`
        <div class="act">
          <button data-act="jump">Skok</button>
          <button data-act="duck">Duck</button>
        </div>`;
      this.mobile.querySelector('[data-act="jump"]').addEventListener('touchstart',()=>gameInstances.dino.jump(),{passive:true});
      this.mobile.querySelector('[data-act="duck"]').addEventListener('touchstart',()=>gameInstances.dino.duck(true),{passive:true});
      this.mobile.querySelector('[data-act="duck"]').addEventListener('touchend',()=>gameInstances.dino.duck(false));
    }else{
      this.mobile.classList.remove('active');
    }
  }
};

// --- PONG ---
gameInstances.pong = {
  canvas:null, music:null, ctx:null, ball:{}, player:{}, computer:{}, paused:false, gameOver:false, loop:null, winningScore:5, winner:null,
  init(){
    this.canvas=document.getElementById('pong-canvas');
    this.music=document.getElementById('pong-music');
    this.ctx=this.canvas.getContext('2d');
    this.reset();
    const moveHandler=(x)=>{
      const rect=this.canvas.getBoundingClientRect();
      this.player.y=clamp(x-rect.top-this.player.height/2,0,this.canvas.height-this.player.height);
    };
    window.addEventListener('mousemove',e=>{ if(activeGame==='pong' && !this.paused){ moveHandler(e.clientY) } });
    // touch move on canvas
    this.canvas.addEventListener('touchmove',(e)=>{
      if(activeGame!=='pong' || this.paused) return;
      moveHandler(e.touches[0].clientY); e.preventDefault();
    },{passive:false});
  },
  reset(){
    this.ball={x:this.canvas.width/2,y:this.canvas.height/2,radius:10,dx:5,dy:5};
    this.player={x:10,y:this.canvas.height/2-50,width:10,height:100,score:0};
    this.computer={x:this.canvas.width-20,y:this.canvas.height/2-50,width:10,height:100,score:0};
    this.gameOver=false; this.winner=null;
  },
  update(){
    if(this.gameOver) return;
    this.ball.x+=this.ball.dx; this.ball.y+=this.ball.dy;
    if(this.ball.y+this.ball.radius>this.canvas.height || this.ball.y-this.ball.radius<0){ this.ball.dy*=-1 }
    // paddles
    if(this.ball.x-this.ball.radius<this.player.x+this.player.width && this.ball.y>this.player.y && this.ball.y<this.player.y+this.player.height){
      this.ball.dx=Math.abs(this.ball.dx)
    }
    if(this.ball.x+this.ball.radius>this.computer.x && this.ball.y>this.computer.y && this.ball.y<this.computer.y+this.computer.height){
      this.ball.dx=-Math.abs(this.ball.dx)
    }
    // score
    if(this.ball.x+this.ball.radius<0){ this.computer.score++; this.resetBall() }
    else if(this.ball.x-this.ball.radius>this.canvas.width){ this.player.score++; this.resetBall() }
    // AI
    this.computer.y += (this.ball.y - (this.computer.y + this.computer.height/2))*0.05;
    this.computer.y = clamp(this.computer.y,0,this.canvas.height-this.computer.height);
    if(this.player.score>=this.winningScore){ this.end('player') }
    else if(this.computer.score>=this.winningScore){ this.end('computer') }
  },
  end(w){ this.gameOver=true; this.winner=w; playSound(w==='player'?'victory-sound':'game-over-sound'); this.stop() },
  resetBall(){ this.ball.x=this.canvas.width/2; this.ball.y=this.canvas.height/2; this.ball.dx*=-1 },
  draw(){
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    this.ctx.fillStyle='#fff';
    this.ctx.beginPath(); this.ctx.arc(this.ball.x,this.ball.y,this.ball.radius,0,Math.PI*2); this.ctx.fill();
    this.ctx.fillRect(this.player.x,this.player.y,this.player.width,this.player.height);
    this.ctx.fillRect(this.computer.x,this.computer.y,this.computer.width,this.computer.height);
    this.ctx.font='32px "Press Start 2P"'; this.ctx.textAlign='left'; this.ctx.fillText(this.player.score, this.canvas.width/4, 50);
    this.ctx.textAlign='right'; this.ctx.fillText(this.computer.score, 3*this.canvas.width/4, 50);
  },
  gameLoop(){ if(!this.paused){ this.update(); this.draw() } this.loop=requestAnimationFrame(this.gameLoop.bind(this)) },
  start(){ this.paused=false; if(this.loop) cancelAnimationFrame(this.loop); this.loop=requestAnimationFrame(this.gameLoop.bind(this)); try{this.music.play()}catch(e){} },
  stop(){ if(this.loop) cancelAnimationFrame(this.loop); this.loop=null; this.paused=true; try{this.music.pause()}catch(e){} document.body.style.overflow='auto' },
  togglePause(){ this.paused=!this.paused; document.body.style.overflow=this.paused?'auto':'hidden'; try{ this.paused?this.music.pause():this.music.play() }catch(e){} }
};

// --- BREAKOUT --- (with more powerups)
gameInstances.breakout = {
  canvas:null, music:null, ctx:null, ball:{}, paddle:{}, bricks:[], powerUps:[], paused:false, gameOver:false, loop:null, lives:3, score:0, victory:false,
  init(){
    this.canvas=document.getElementById('breakout-canvas');
    this.music=document.getElementById('breakout-music');
    this.ctx=this.canvas.getContext('2d');
    this.reset();
    const move=(clientX)=>{
      const rect=this.canvas.getBoundingClientRect();
      this.paddle.x=clamp(clientX-rect.left-this.paddle.width/2,0,this.canvas.width-this.paddle.width);
    };
    window.addEventListener('mousemove',(e)=>{ if(activeGame==='breakout' && !this.paused){ move(e.clientX) } });
    this.canvas.addEventListener('touchmove',(e)=>{ if(activeGame!=='breakout'||this.paused) return; move(e.touches[0].clientX); e.preventDefault() },{passive:false});
  },
  reset(){
    this.ball={x:this.canvas.width/2,y:this.canvas.height-50,radius:8,dx:4,dy:-4,baseSpeed:4};
    this.paddle={x:this.canvas.width/2-50,y:this.canvas.height-20,width:100,height:10};
    this.lives=3; this.score=0; this.gameOver=false; this.victory=false; this.powerUps=[];
    // bricks
    this.bricks=[]; const rows=7, cols=10, pad=2;
    const bw=(this.canvas.width - pad*(cols+1))/cols, bh=20;
    const colors=['#ef4444','#f97316','#eab308','#84cc16','#22c55e','#14b8a6','#06b6d4'];
    for(let c=0;c<cols;c++){ for(let r=0;r<rows;r++){ this.bricks.push({x:pad+c*(bw+pad),y:pad+r*(bh+pad)+30,width:bw,height:bh,color:colors[r%colors.length],visible:true}) } }
  },
  update(){
    if(this.gameOver) return;
    const b=this.ball;
    b.x+=b.dx; b.y+=b.dy;
    if(b.x+b.radius>this.canvas.width || b.x-b.radius<0) b.dx*=-1;
    if(b.y-b.radius<0) b.dy*=-1;
    // paddle
    if(b.y+b.radius>this.paddle.y && b.x>this.paddle.x && b.x<this.paddle.x+this.paddle.width && b.dy>0){
      b.dy*=-1;
      // add a little english based on hit position
      const hit=(b.x-(this.paddle.x+this.paddle.width/2))/(this.paddle.width/2);
      b.dx = clamp(b.dx + hit*1.5, -6, 6);
    }
    // bricks
    this.bricks.forEach(br=>{
      if(!br.visible) return;
      if(b.x>br.x && b.x<br.x+br.width && b.y>br.y && b.y<br.y+br.height){
        br.visible=false; b.dy*=-1; this.score+=10;
        // drop random powerups
        const types=['widen','shrink','slow','speed','life'];
        if(Math.random()<0.35){
          const t=types[Math.floor(Math.random()*types.length)];
          this.powerUps.push({x:br.x+br.width/2,y:br.y,type:t,vy:2});
        }
      }
    });
    this.bricks=this.bricks.filter(bk=>bk.visible);
    // powerups move & collect
    for(let i=this.powerUps.length-1;i>=0;i--){
      const pu=this.powerUps[i]; pu.y+=pu.vy;
      if(pu.y>this.paddle.y && pu.x>this.paddle.x && pu.x<this.paddle.x+this.paddle.width){
        this.applyPowerUp(pu.type); this.powerUps.splice(i,1);
      }else if(pu.y>this.canvas.height){ this.powerUps.splice(i,1) }
    }
    // lose life
    if(b.y+b.radius>this.canvas.height){
      this.lives--;
      if(this.lives<=0){ this.gameOver=true; playSound('game-over-sound'); this.stop() }
      else { this.ball={x:this.canvas.width/2,y:this.canvas.height-50,radius:8,dx:4,dy:-4,baseSpeed:4} }
    }
    // victory
    if(this.bricks.length===0){ this.gameOver=true; this.victory=true; playSound('victory-sound'); this.stop() }
  },
  applyPowerUp(type){
    if(type==='widen'){ this.paddle.width=Math.min(this.paddle.width+30,220) }
    else if(type==='shrink'){ this.paddle.width=Math.max(this.paddle.width-25,60) }
    else if(type==='slow'){ this.ball.dx*=0.85; this.ball.dy*=0.85 }
    else if(type==='speed'){ this.ball.dx*=1.15; this.ball.dy*=1.15 }
    else if(type==='life'){ this.lives=Math.min(this.lives+1,9) }
  },
  draw(){
    const ctx=this.ctx, b=this.ball;
    ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    // ball
    ctx.beginPath(); ctx.arc(b.x,b.y,b.radius,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
    // paddle
    ctx.fillStyle='#4f46e5'; ctx.fillRect(this.paddle.x,this.paddle.y,this.paddle.width,this.paddle.height);
    // bricks
    this.bricks.forEach(br=>{ if(br.visible){ ctx.fillStyle=br.color; ctx.fillRect(br.x,br.y,br.width,br.height) } });
    // powerups
    this.powerUps.forEach(pu=>{ ctx.fillStyle=pu.type==='life'?'#22c55e':(pu.type==='widen'?'#38bdf8':pu.type==='shrink'?'#f43f5e':pu.type==='slow'?'#fde047':'#a78bfa'); ctx.fillRect(pu.x-6,pu.y-6,12,12) });
    // UI
    ctx.fillStyle='#fff'; ctx.font='16px "Silkscreen"'; ctx.fillText(`Lives: ${this.lives}`,10,20); ctx.fillText(`Score: ${this.score}`, this.canvas.width-120, 20);
  },
  gameLoop(){ if(!this.paused){ this.update(); this.draw() } this.loop=requestAnimationFrame(this.gameLoop.bind(this)) },
  start(){ this.paused=false; if(this.loop) cancelAnimationFrame(this.loop); this.loop=requestAnimationFrame(this.gameLoop.bind(this)); try{this.music.play()}catch(e){} },
  stop(){ if(this.loop) cancelAnimationFrame(this.loop); this.loop=null; this.paused=true; try{this.music.pause()}catch(e){} document.body.style.overflow='auto' },
  togglePause(){ this.paused=!this.paused; document.body.style.overflow=this.paused?'auto':'hidden'; try{ this.paused?this.music.pause():this.music.play() }catch(e){} }
};

// --- DINO ---
gameInstances.dino = {
  canvas:null, music:null, ctx:null, dino:{}, obstacles:[], gameSpeed:5, gravity:0.6, score:0, frameCount:0, paused:false, gameOver:false, loop:null,
  init(){
    this.canvas=document.getElementById('dino-canvas'); this.music=document.getElementById('dino-music'); this.ctx=this.canvas.getContext('2d');
    this.reset(); window.addEventListener('keydown',this.handleInput.bind(this)); window.addEventListener('keyup',this.handleKeyUp.bind(this));
  },
  reset(){ this.dino={x:50,y:this.canvas.height-50,width:40,height:50,dy:0,jumpPower:15,grounded:true,isDucking:false,runFrame:0}; this.obstacles=[]; this.score=0; this.gameSpeed=5; this.frameCount=0; this.gameOver=false; },
  handleInput(e){ if(activeGame!=='dino'||this.paused||this.gameOver) return; if((e.code==='Space'||e.code==='ArrowUp')&&this.dino.grounded){ this.dino.dy=-this.dino.jumpPower; this.dino.grounded=false } if(e.code==='ArrowDown'){ this.dino.isDucking=true } },
  handleKeyUp(e){ if(activeGame==='dino'&&e.code==='ArrowDown'){ this.dino.isDucking=false } },
  jump(){ if(this.dino.grounded){ this.dino.dy=-this.dino.jumpPower; this.dino.grounded=false } },
  duck(v){ this.dino.isDucking=!!v },
  update(){
    if(this.gameOver) return; this.frameCount++;
    this.dino.dy+=this.gravity; this.dino.y+=this.dino.dy; this.dino.grounded=false;
    if(this.dino.y>=this.canvas.height-50){ this.dino.y=this.canvas.height-50; this.dino.dy=0; this.dino.grounded=true }
    if(this.dino.grounded && this.frameCount%5===0){ this.dino.runFrame=(this.dino.runFrame+1)%2 }
    if(this.frameCount % Math.floor(150/(this.gameSpeed/5))===0){
      const type=Math.random()>0.3?'cactus':'bird';
      if(type==='cactus'){ const h=Math.floor(Math.random()*30)+20; this.obstacles.push({x:this.canvas.width,y:this.canvas.height-h,width:20,height:h,type:'cactus'}) }
      else{ this.obstacles.push({x:this.canvas.width,y:this.canvas.height-70,width:40,height:20,type:'bird',frame:0}) }
    }
    for(let i=this.obstacles.length-1;i>=0;i--){
      const o=this.obstacles[i]; o.x-=this.gameSpeed; if(o.type==='bird'&&this.frameCount%10===0) o.frame=(o.frame+1)%2; if(o.x+o.width<0) this.obstacles.splice(i,1);
      const dH=this.dino.isDucking?this.dino.height/2:this.dino.height, dY=this.dino.isDucking?this.dino.y+this.dino.height/2:this.dino.y;
      if(this.dino.x<o.x+o.width && this.dino.x+this.dino.width>o.x && dY<o.y+o.height && dY+dH>o.y){ this.gameOver=true; playSound('game-over-sound'); this.stop() }
    }
    this.score++; if(this.score%100===0) this.gameSpeed+=0.2;
  },
  drawDino(){
    const ctx=this.ctx,d=this.dino; ctx.fillStyle='#d4d4d8';
    const y=d.isDucking?d.y+d.height/2:d.y, h=d.isDucking?d.height/2:d.height;
    ctx.fillRect(d.x,y,d.width,h); ctx.fillRect(d.x+d.width*.7,y,d.width*.6,h*.5);
    ctx.fillStyle='#000'; ctx.fillRect(d.x+d.width*1.1, y+h*.1,5,5);
    ctx.fillStyle='#d4d4d8'; if(d.grounded){ if(d.runFrame===0){ ctx.fillRect(d.x+10,y+h,8,15); ctx.fillRect(d.x+25,y+h,8,10) } else { ctx.fillRect(d.x+10,y+h,8,10); ctx.fillRect(d.x+25,y+h,8,15) } }
  },
  drawObstacle(o){
    const ctx=this.ctx; ctx.fillStyle='#84cc16';
    if(o.type==='cactus'){ ctx.fillRect(o.x,o.y,o.width,o.height); if(o.height>25) ctx.fillRect(o.x-5,o.y+5,5,10); if(o.height>35) ctx.fillRect(o.x+o.width,o.y+10,5,10) }
    else{ ctx.fillRect(o.x,o.y+10,o.width,o.height*.5); if(o.frame===0){ ctx.fillRect(o.x-10,o.y,10,5) } else { ctx.fillRect(o.x-10,o.y+15,10,5) } }
  },
  draw(){
    const ctx=this.ctx; ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    ctx.fillStyle='#a1a1aa'; ctx.fillRect(0,this.canvas.height-20,this.canvas.width,20);
    this.drawDino(); this.obstacles.forEach(o=>this.drawObstacle(o));
    ctx.fillStyle='#fff'; ctx.font='20px "Silkscreen"'; ctx.fillText(`Score: ${this.score}`,10,30);
  },
  gameLoop(){ if(!this.paused){ this.update(); this.draw() } this.loop=requestAnimationFrame(this.gameLoop.bind(this)) },
  start(){ this.paused=false; if(this.loop) cancelAnimationFrame(this.loop); this.loop=requestAnimationFrame(this.gameLoop.bind(this)); try{this.music.play()}catch(e){} },
  stop(){ if(this.loop) cancelAnimationFrame(this.loop); this.loop=null; this.paused=true; try{this.music.pause()}catch(e){} document.body.style.overflow='auto' },
  togglePause(){ this.paused=!this.paused; document.body.style.overflow=this.paused?'auto':'hidden'; try{ this.paused?this.music.pause():this.music.play() }catch(e){} }
};

// --- TETRIS ---
gameInstances.tetris = {
  canvas:null,nextCanvas:null,music:null,ctx:null,nextCtx:null,grid:null,player:{pos:{x:0,y:0},matrix:null},colors:[null,'#ef4444','#f97316','#eab308','#84cc16','#22c55e','#06b6d4','#3b82f6'],
  cols:12,rows:20,blockSize:0,dropCounter:0,dropInterval:1000,lastTime:0,score:0,paused:false,gameOver:false,loop:null,nextPiece:null,
  init(){
    this.canvas=document.getElementById('tetris-canvas'); this.nextCanvas=document.getElementById('next-piece-canvas'); this.music=document.getElementById('tetris-music');
    this.ctx=this.canvas.getContext('2d'); this.nextCtx=this.nextCanvas.getContext('2d'); window.addEventListener('keydown',this.handleInput.bind(this)); this.reset();
  },
  reset(){ this.grid=this.createMatrix(this.cols,this.rows); this.nextPiece=this.createPiece('TJLOSZI'[Math.floor(Math.random()*7)]); this.playerReset(); this.score=0; this.gameOver=false },
  createMatrix(w,h){ const m=[]; while(h--) m.push(new Array(w).fill(0)); return m },
  createPiece(t){ if(t==='T')return[[0,0,0],[1,1,1],[0,1,0]]; if(t==='J')return[[0,2,0],[0,2,0],[2,2,0]]; if(t==='L')return[[0,3,0],[0,3,0],[0,3,3]]; if(t==='O')return[[4,4],[4,4]]; if(t==='I')return[[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]]; if(t==='S')return[[0,6,6],[6,6,0],[0,0,0]]; if(t==='Z')return[[7,7,0],[0,7,7],[0,0,0]] },
  playerReset(){ this.player.matrix=this.nextPiece; this.nextPiece=this.createPiece('TJLOSZI'[Math.floor(Math.random()*7)]); this.player.pos.y=0; this.player.pos.x=(this.cols/2|0)-(this.player.matrix[0].length/2|0); if(this.collide(this.grid,this.player)){ this.gameOver=true; playSound('game-over-sound'); this.stop() } },
  collide(grid,player){ const m=player.matrix,o=player.pos; for(let y=0;y<m.length;++y){ for(let x=0;x<m[y].length;++x){ if(m[y][x]!==0){ const row=grid[y+o.y]; if(!row || row[x+o.x]!==0) return true } } } return false },
  merge(grid,player){ player.matrix.forEach((row,y)=>row.forEach((v,x)=>{ if(v!==0) grid[y+player.pos.y][x+player.pos.x]=v })) },
  rotate(m,dir){ for(let y=0;y<m.length;++y){ for(let x=0;x<y;++x){ [m[x][y],m[y][x]]=[m[y][x],m[x][y]] } } if(dir>0) m.forEach(r=>r.reverse()); else m.reverse() },
  playerRotate(dir){ const pos=this.player.pos.x; let offset=1; this.rotate(this.player.matrix,dir); while(this.collide(this.grid,this.player)){ this.player.pos.x+=offset; offset=-(offset+(offset>0?1:-1)); if(offset>this.player.matrix[0].length){ this.rotate(this.player.matrix,-dir); this.player.pos.x=pos; return } } },
  gridSweep(){ outer: for(let y=this.grid.length-1;y>0;--y){ for(let x=0;x<this.grid[y].length;++x){ if(this.grid[y][x]===0) continue outer } const row=this.grid.splice(y,1)[0].fill(0); this.grid.unshift(row); ++y; this.score+=10 } },
  handleInput(e){ if(activeGame!=='tetris'||this.paused||this.gameOver) return; if(e.key==='ArrowLeft') this.playerMove(-1); else if(e.key==='ArrowRight') this.playerMove(1); else if(e.key==='ArrowDown') this.playerDrop(); else if(e.key==='ArrowUp') this.playerRotate(1) },
  playerMove(dir){ this.player.pos.x+=dir; if(this.collide(this.grid,this.player)) this.player.pos.x-=dir },
  playerDrop(){ this.player.pos.y++; if(this.collide(this.grid,this.player)){ this.player.pos.y--; this.merge(this.grid,this.player); this.playerReset(); this.gridSweep() } this.dropCounter=0 },
  update(time=0){ if(this.gameOver) return; const dt=time-this.lastTime; this.lastTime=time; this.dropCounter+=dt; if(this.dropCounter>this.dropInterval){ this.playerDrop() } },
  drawMatrix(matrix,offset,target){ matrix.forEach((row,y)=>row.forEach((v,x)=>{ if(v!==0){ target.fillStyle=this.colors[v]; target.fillRect(x+offset.x,y+offset.y,1,1) } })) },
  draw(){
    this.ctx.setTransform(1,0,0,1,0,0); this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    this.ctx.setTransform(this.blockSize,0,0,this.blockSize,0,0);
    this.ctx.fillStyle='#0f172a'; this.ctx.fillRect(0,0,this.canvas.width/this.blockSize,this.canvas.height/this.blockSize);
    if(!this.grid||!this.player.matrix) return;
    this.drawMatrix(this.grid,{x:0,y:0},this.ctx); this.drawMatrix(this.player.matrix,this.player.pos,this.ctx);
    // next
    this.nextCtx.setTransform(1,0,0,1,0,0); this.nextCtx.clearRect(0,0,this.nextCanvas.width,this.nextCanvas.height);
    this.nextCtx.fillStyle='#0d1117'; this.nextCtx.fillRect(0,0,this.nextCanvas.width,this.nextCanvas.height);
    this.nextCtx.setTransform(20,0,0,20,0,0); this.drawMatrix(this.nextPiece,{x:1,y:1},this.nextCtx);
    // score
    this.ctx.fillStyle='#fff'; this.ctx.font='1px "Silkscreen"'; this.ctx.fillText(`Score: ${this.score}`,0.5,1);
  },
  gameLoop(time){ if(!this.paused){ this.update(time); this.draw() } this.loop=requestAnimationFrame(this.gameLoop.bind(this)) },
  start(){ this.blockSize=Math.floor(Math.min(this.canvas.width/this.cols,this.canvas.height/this.rows))||20; this.nextCanvas.width=80; this.nextCanvas.height=80; this.paused=false; this.lastTime=0; this.dropCounter=0; if(this.loop) cancelAnimationFrame(this.loop); this.loop=requestAnimationFrame(this.gameLoop.bind(this)); try{this.music.play()}catch(e){} this.nextCanvas.classList.remove('hidden') },
  stop(){ if(this.loop) cancelAnimationFrame(this.loop); this.loop=null; this.paused=true; try{this.music.pause()}catch(e){} document.body.style.overflow='auto'; this.nextCanvas.classList.add('hidden') },
  togglePause(){ this.paused=!this.paused; document.body.style.overflow=this.paused?'auto':'hidden'; try{ this.paused?this.music.pause():this.music.play() }catch(e){} }
};

// --- SNAKE --- (new)
gameInstances.snake = {
  canvas:null, ctx:null, music:null, gridSize:20, cols:20, rows:20, snake:[], dir:{x:1,y:0}, nextDir:{x:1,y:0}, food:null, paused:false, gameOver:false, loop:null, speed:120, last:0, score:0,
  init(){
    this.canvas=document.getElementById('snake-canvas'); this.ctx=this.canvas.getContext('2d'); this.music=document.getElementById('snake-music'); this.reset();
    window.addEventListener('keydown',(e)=>{
      if(activeGame!=='snake'||this.paused||this.gameOver) return;
      if(e.key==='ArrowUp' && this.dir.y!==1) this.nextDir={x:0,y:-1};
      else if(e.key==='ArrowDown' && this.dir.y!==-1) this.nextDir={x:0,y:1};
      else if(e.key==='ArrowLeft' && this.dir.x!==1) this.nextDir={x:-1,y:0};
      else if(e.key==='ArrowRight' && this.dir.x!==-1) this.nextDir={x:1,y:0};
    });
  },
  setDirection(d){
    if(d==='up' && this.dir.y!==1) this.nextDir={x:0,y:-1};
    if(d==='down' && this.dir.y!==-1) this.nextDir={x:0,y:1};
    if(d==='left' && this.dir.x!==1) this.nextDir={x:-1,y:0};
    if(d==='right' && this.dir.x!==-1) this.nextDir={x:1,y:0};
  },
  reset(){
    this.cols=Math.floor(this.canvas.width/this.gridSize)||20;
    this.rows=Math.floor(this.canvas.height/this.gridSize)||15;
    this.snake=[{x:Math.floor(this.cols/2),y:Math.floor(this.rows/2)}];
    this.dir={x:1,y:0}; this.nextDir={x:1,y:0};
    this.spawnFood(); this.gameOver=false; this.score=0; this.speed=120; this.last=0;
  },
  spawnFood(){
    this.food={x:Math.floor(Math.random()*this.cols), y:Math.floor(Math.random()*this.rows)};
    // prevent spawning on snake
    if(this.snake.some(s=>s.x===this.food.x && s.y===this.food.y)) this.spawnFood();
  },
  step(){
    this.dir=this.nextDir;
    const head={x:this.snake[0].x+this.dir.x, y:this.snake[0].y+this.dir.y};
    // collisions
    if(head.x<0||head.y<0||head.x>=this.cols||head.y>=this.rows || this.snake.some(s=>s.x===head.x&&s.y===head.y)){
      this.gameOver=true; playSound('game-over-sound'); this.stop(); return;
    }
    this.snake.unshift(head);
    if(head.x===this.food.x && head.y===this.food.y){
      this.score++; if(this.speed>60) this.speed-=4; this.spawnFood();
    }else{
      this.snake.pop();
    }
  },
  draw(){
    const ctx=this.ctx; ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    // grid bg
    ctx.fillStyle='#052e16'; ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
    // food
    ctx.fillStyle='#ef4444'; ctx.fillRect(this.food.x*this.gridSize,this.food.y*this.gridSize,this.gridSize,this.gridSize);
    // snake
    ctx.fillStyle='#22c55e';
    this.snake.forEach((s,i)=>{
      ctx.fillRect(s.x*this.gridSize, s.y*this.gridSize, this.gridSize-1, this.gridSize-1);
    });
    ctx.fillStyle='#fff'; ctx.font='16px "Silkscreen"'; ctx.fillText(`Score: ${this.score}`,10,20);
  },
  loopFn(ts){ if(!this.paused && !this.gameOver){ if(ts-this.last>this.speed){ this.step(); this.last=ts; } this.draw() } this.loop=requestAnimationFrame(this.loopFn.bind(this)) },
  start(){ this.paused=false; if(this.loop) cancelAnimationFrame(this.loop); this.loop=requestAnimationFrame(this.loopFn.bind(this)); try{this.music.play()}catch(e){} },
  stop(){ if(this.loop) cancelAnimationFrame(this.loop); this.loop=null; this.paused=true; try{this.music.pause()}catch(e){} document.body.style.overflow='auto' },
  togglePause(){ this.paused=!this.paused; document.body.style.overflow=this.paused?'auto':'hidden'; try{ this.paused?this.music.pause():this.music.play() }catch(e){} }
};

// --- SPACE INVADERS --- (new, simplified)
gameInstances.invaders = {
  canvas:null, ctx:null, music:null, player:null, bullets:[], enemies:[], enemyDir:1, enemyStep:0, enemySpeed:20, enemyDownStep:16, paused:false, gameOver:false, loop:null, last:0, fireCooldown:0,
  init(){
    this.canvas=document.getElementById('invaders-canvas'); this.ctx=this.canvas.getContext('2d'); this.music=document.getElementById('invaders-music');
    this.reset();
    window.addEventListener('keydown',(e)=>{
      if(activeGame!=='invaders'||this.paused||this.gameOver) return;
      if(e.key==='ArrowLeft') this.player.x-=10;
      else if(e.key==='ArrowRight') this.player.x+=10;
      else if(e.code==='Space'){ this.shoot() }
      this.player.x=clamp(this.player.x,10,this.canvas.width-10-this.player.w);
    });
  },
  touchMove(dir){ if(activeGame!=='invaders'||this.paused||this.gameOver) return; this.player.x=clamp(this.player.x + dir*14, 10, this.canvas.width-10-this.player.w) },
  shoot(){
    const now=performance.now();
    if(now-this.fireCooldown<200) return; // simple ROF limit
    this.fireCooldown=now;
    this.bullets.push({x:this.player.x+this.player.w/2,y:this.player.y-6,vy:-6,owner:'player'});
  },
  reset(){
    this.player={x:this.canvas.width/2-15,y:this.canvas.height-30,w:30,h:10};
    this.bullets=[]; this.enemies=[]; this.enemyDir=1; this.enemyStep=0; this.enemySpeed=20; this.gameOver=false;
    // build enemy grid
    const rows=4, cols=8, pad=10, ew=24, eh=16, offsetX=30, offsetY=30;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        this.enemies.push({x:offsetX+c*(ew+pad), y:offsetY+r*(eh+pad), w:ew, h:eh, alive:true});
      }
    }
  },
  update(ts){
    // move enemies horizontally; step down at edges
    if(this.enemyStep++ % this.enemySpeed === 0){
      let hitEdge=false;
      this.enemies.forEach(e=>{ if(!e.alive) return; e.x += this.enemyDir*8; if(e.x<10 || e.x+e.w>this.canvas.width-10) hitEdge=true });
      if(hitEdge){ this.enemyDir*=-1; this.enemies.forEach(e=>{ if(e.alive) e.y += this.enemyDownStep }) }
    }
    // random enemy shots
    if(Math.random()<0.02){
      const shooters=this.enemies.filter(e=>e.alive);
      if(shooters.length){
        const s=shooters[Math.floor(Math.random()*shooters.length)];
        this.bullets.push({x:s.x+s.w/2,y:s.y+s.h,vy:3,owner:'enemy'});
      }
    }
    // bullets
    for(let i=this.bullets.length-1;i>=0;i--){
      const b=this.bullets[i]; b.y+=b.vy;
      // remove offscreen
      if(b.y<-10 || b.y>this.canvas.height+10){ this.bullets.splice(i,1); continue }
      if(b.owner==='player'){
        // hit enemy
        for(const e of this.enemies){
          if(e.alive && b.x>e.x && b.x<e.x+e.w && b.y>e.y && b.y<e.y+e.h){
            e.alive=false; this.bullets.splice(i,1); break;
          }
        }
      }else{
        // enemy bullet hits player
        const p=this.player;
        if(b.x>p.x && b.x<p.x+p.w && b.y>p.y && b.y<p.y+p.h){
          this.gameOver=true; playSound('game-over-sound'); this.stop(); break;
        }
      }
    }
    // lose if enemy reaches bottom
    if(this.enemies.some(e=>e.alive && e.y+e.h>=this.player.y-4)){ this.gameOver=true; playSound('game-over-sound'); this.stop() }
    // victory
    if(this.enemies.every(e=>!e.alive)){ playSound('victory-sound'); this.stop() }
  },
  draw(){
    const ctx=this.ctx; ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    // player
    ctx.fillStyle='#38bdf8'; const p=this.player; ctx.fillRect(p.x,p.y,p.w,p.h);
    // enemies
    ctx.fillStyle='#f0abfc';
    this.enemies.forEach(e=>{ if(e.alive) ctx.fillRect(e.x,e.y,e.w,e.h) });
    // bullets
    this.bullets.forEach(b=>{ ctx.fillStyle=b.owner==='player'?'#fff':'#f87171'; ctx.fillRect(b.x-2,b.y-6,4,8) });
  },
  gameLoop(ts){ if(!this.paused && !this.gameOver){ this.update(ts); this.draw() } this.loop=requestAnimationFrame(this.gameLoop.bind(this)) },
  start(){ this.paused=false; if(this.loop) cancelAnimationFrame(this.loop); this.loop=requestAnimationFrame(this.gameLoop.bind(this)); try{this.music.play()}catch(e){} },
  stop(){ if(this.loop) cancelAnimationFrame(this.loop); this.loop=null; this.paused=true; try{this.music.pause()}catch(e){} document.body.style.overflow='auto' },
  togglePause(){ this.paused=!this.paused; document.body.style.overflow=this.paused?'auto':'hidden'; try{ this.paused?this.music.pause():this.music.play() }catch(e){} }
};

// --- MAIN ---
document.addEventListener('DOMContentLoaded',()=>{
  ui.mount();
  const gameWindows=document.querySelectorAll('.game-window');
  Object.values(gameInstances).forEach(g=>g.init());

  gameWindows.forEach(win=>{
    win.addEventListener('click',()=>{
      const gameName=win.dataset.game;
      const game=gameInstances[gameName];
      if(!game) return;

      // deactivate previous
      if(activeGame && gameInstances[activeGame]){
        gameInstances[activeGame].stop();
        const prev=document.querySelector(`[data-game="${activeGame}"]`);
        if(prev) prev.classList.remove('active');
      }

      document.body.style.overflow='hidden';
      activeGame=gameName;
      win.classList.add('active');

      // sync canvas real size with CSS
      const canvas = win.querySelector('canvas');
      canvas.width=Math.floor(canvas.offsetWidth);
      canvas.height=Math.floor(canvas.offsetHeight);
      if(gameName==='tetris'){
        const n=document.getElementById('next-piece-canvas');
        n.width=80; n.height=80;
      }

      game.reset && game.reset();
      game.draw && game.draw();
      ui.show(gameName);
      playCountdown(()=>game.start());
    });
  });

  // UI visibility on resize: keep active centered
  window.addEventListener('resize',()=>{
    const win=document.querySelector('.game-window.active');
    if(win){
      const canvas=win.querySelector('canvas');
      canvas.width=Math.floor(canvas.offsetWidth);
      canvas.height=Math.floor(canvas.offsetHeight);
    }
  });
});
</script>
</body>
</html>
